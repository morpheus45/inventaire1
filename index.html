<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventaire - Bon retour / sortie</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="icon" href="./icon-192.png">

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;margin:0;background:#f6f7fb;color:#111}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid rgba(0,0,0,.06);padding:14px 16px;z-index:5}
    h1{font-size:18px;margin:0}
    main{padding:16px;max-width:920px;margin:0 auto}
    .card{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:16px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.04)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    .field-label{display:block;font-weight:700;margin:4px 0 6px}
    input, textarea, select{width:100%;padding:12px 12px;border:1px solid rgba(0,0,0,.14);border-radius:12px;background:#fff;font-size:16px}
    textarea{min-height:90px;resize:vertical}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:14px;padding:12px 14px;background:#111;color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#eef1ff;color:#111;border:1px solid rgba(0,0,0,.08)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:#666;font-size:13px;line-height:1.4}
    .sep{height:1px;background:rgba(0,0,0,.06);margin:14px 0}

    /* ===== NEUF / USITÉ (comme demandé) ===== */
    .condition-row{display:flex;gap:14px;margin-top:12px;flex-wrap:wrap}
    .cond-card{flex:1;min-width:260px;border-radius:14px;padding:14px 14px 10px;box-shadow:0 1px 0 rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.06)}
    .cond-neuf{background:#eef4ff}
    .cond-usite{background:#fbf3dd}
    .cond-title{font-weight:800;letter-spacing:.4px;margin-bottom:10px}
    .cond-line{display:flex;align-items:center;justify-content:space-between;padding:8px 0}

    .switch{position:relative;display:inline-block;width:52px;height:28px}
    .switch input{display:none}
    .slider{position:absolute;cursor:pointer;inset:0;background:#d9d9d9;border-radius:999px;transition:.2s}
    .slider:before{content:"";position:absolute;height:22px;width:22px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.25)}
    .switch input:checked + .slider{background:#2f6bff}
    .switch input:checked + .slider:before{transform:translateX(24px)}

    /* ===== Références (datalist) : robuste Android / PWA ===== */
    .refInput{position:relative;z-index:10}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#f0f2f7;border:1px solid rgba(0,0,0,.06);font-size:12px}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>

<body>
  <header>
    <h1>Inventaire — Bon retour / sortie</h1>
  </header>

  <main>
    <div class="card article">
      <div class="row">
        <span class="pill">Correctif menu références + NEUF/USITÉ</span>
        <span class="pill code">index.html</span>
      </div>

      <div class="sep"></div>

      <div class="grid">
        <div>
          <label class="field-label">Client / Site</label>
          <input type="text" name="site" placeholder="Ex : Client, adresse..." />
        </div>

        <div>
          <label class="field-label">Technicien</label>
          <input type="text" name="technicien" placeholder="Ex : Prénom Nom" />
        </div>
      </div>

      <div style="margin-top:12px">
        <label class="field-label">Article de référence</label>

        <!-- Remplace le select par datalist (moins de bugs sur Android/PWA) -->
        <input class="refInput" list="refList" placeholder="Choisir une référence..." autocomplete="off">
        <datalist id="refList"></datalist>

        <input type="hidden" class="refValue" name="reference_value" value="">
        <input type="hidden" class="refLabel" name="reference_label" value="">
        <div class="muted" style="margin-top:6px">
          Astuce : la liste peut être alimentée depuis <span class="code">localStorage</span> (clé <span class="code">REFERENCES_LIST</span>).
        </div>
      </div>

      <div style="margin-top:14px">
        <label class="field-label">Commentaire</label>
        <textarea name="commentaire" placeholder="Ex : N° série, remarque, état, etc."></textarea>
      </div>

      <!-- NEUF / USITÉ -->
      <div class="condition-row">
        <div class="cond-card cond-neuf">
          <div class="cond-title">NEUF</div>

          <div class="cond-line">
            <span>Oui</span>
            <label class="switch">
              <input type="checkbox" class="cond-toggle" data-type="neuf" data-value="oui">
              <span class="slider"></span>
            </label>
          </div>

          <div class="cond-line">
            <span>Non</span>
            <label class="switch">
              <input type="checkbox" class="cond-toggle" data-type="neuf" data-value="non" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="cond-card cond-usite">
          <div class="cond-title">USITÉ</div>

          <div class="cond-line">
            <span>Oui</span>
            <label class="switch">
              <input type="checkbox" class="cond-toggle" data-type="usite" data-value="oui">
              <span class="slider"></span>
            </label>
          </div>

          <div class="cond-line">
            <span>Non</span>
            <label class="switch">
              <input type="checkbox" class="cond-toggle" data-type="usite" data-value="non" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>

      <input type="hidden" class="etat-materiel" name="etat_materiel" value="">

      <div class="sep"></div>

      <div class="row">
        <button class="btn" type="button" id="btnSaveDemo">Enregistrer (démo)</button>
        <button class="btn secondary" type="button" id="btnClearDemo">Réinitialiser</button>
      </div>

      <div class="muted" style="margin-top:10px">
        Si tu utilises une PWA : pense à vider le cache/service worker après mise à jour (voir README dans le zip).
      </div>
    </div>
  </main>

  <script>
    // ===== PWA (service worker) =====
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(() => {});
      });
    }

    // ===== REFERENCES (datalist) =====
    // 1) Priorité : liste stockée dans localStorage sous "REFERENCES_LIST"
    //    - format accepté : ["REF-001", "REF-002"] OU [{value:"REF-001", label:"REF-001 - ..."}]
    // 2) Sinon : fallback vide (tu peux mettre une liste ici si tu veux)
    const FALLBACK_REFERENCES = [];

    function loadReferencesFromStorage() {
      try {
        const raw = localStorage.getItem("REFERENCES_LIST");
        const arr = raw ? JSON.parse(raw) : null;
        return Array.isArray(arr) ? arr : null;
      } catch (e) { return null; }
    }

    function getReferences() {
      const stored = loadReferencesFromStorage();
      if (stored) return stored;
      return FALLBACK_REFERENCES;
    }

    function renderRefDatalist() {
      const dl = document.getElementById("refList");
      if (!dl) return;
      dl.innerHTML = "";

      const refs = getReferences();
      refs.forEach(r => {
        const opt = document.createElement("option");
        if (typeof r === "string") opt.value = r;
        else opt.value = (r.label || r.value || "");
        dl.appendChild(opt);
      });
    }

    document.addEventListener("input", (e) => {
      if (!e.target.classList.contains("refInput")) return;

      const input = e.target;
      const container = input.closest(".article") || document;

      const refs = getReferences();
      const match = refs.find(r =>
        (typeof r === "string" && r === input.value) ||
        (typeof r === "object" && (r.label === input.value || r.value === input.value))
      );

      const hiddenValue = container.querySelector(".refValue");
      const hiddenLabel = container.querySelector(".refLabel");

      if (match) {
        if (typeof match === "string") {
          if (hiddenValue) hiddenValue.value = match;
          if (hiddenLabel) hiddenLabel.value = match;
        } else {
          if (hiddenValue) hiddenValue.value = match.value || match.label || "";
          if (hiddenLabel) hiddenLabel.value = match.label || match.value || "";
        }
      } else {
        if (hiddenValue) hiddenValue.value = "";
        if (hiddenLabel) hiddenLabel.value = "";
      }
    });

    // ===== NEUF / USITÉ (exclusifs + champ caché) =====
    document.addEventListener("change", (e) => {
      const t = e.target;
      if (!t.classList.contains("cond-toggle")) return;

      const container = t.closest(".article") || document;
      const type = t.dataset.type;   // neuf/usite
      const value = t.dataset.value; // oui/non

      // exclusif Oui/Non dans le même bloc
      container.querySelectorAll(`.cond-toggle[data-type="${type}"]`).forEach(chk => {
        if (chk !== t) chk.checked = false;
      });

      // si Oui => l'autre passe à Non
      if (value === "oui" && t.checked) {
        const otherType = (type === "neuf") ? "usite" : "neuf";
        const otherOui = container.querySelector(`.cond-toggle[data-type="${otherType}"][data-value="oui"]`);
        const otherNon = container.querySelector(`.cond-toggle[data-type="${otherType}"][data-value="non"]`);
        if (otherOui) otherOui.checked = false;
        if (otherNon) otherNon.checked = true;
      }

      // éviter état vide : si on décoche "Non" sans cocher "Oui", on remet "Non"
      if (value === "non" && !t.checked) {
        const oui = container.querySelector(`.cond-toggle[data-type="${type}"][data-value="oui"]`);
        if (!oui || !oui.checked) t.checked = true;
      }

      // valeur finale dans le champ caché
      const neufOui = container.querySelector(`.cond-toggle[data-type="neuf"][data-value="oui"]`)?.checked;
      const usiteOui = container.querySelector(`.cond-toggle[data-type="usite"][data-value="oui"]`)?.checked;

      const hidden = container.querySelector(".etat-materiel");
      if (hidden) hidden.value = neufOui ? "neuf" : (usiteOui ? "usite" : "");
    });

    // ===== Démo : sauvegarde/clear =====
    document.getElementById("btnSaveDemo").addEventListener("click", () => {
      const ref = document.querySelector(".refValue")?.value || "";
      const etat = document.querySelector(".etat-materiel")?.value || "";
      alert("Démo sauvegarde:\nRéférence=" + ref + "\nÉtat=" + etat);
    });
    document.getElementById("btnClearDemo").addEventListener("click", () => {
      const input = document.querySelector(".refInput");
      const v = document.querySelector(".refValue");
      const l = document.querySelector(".refLabel");
      const et = document.querySelector(".etat-materiel");
      if (input) input.value = "";
      if (v) v.value = "";
      if (l) l.value = "";
      if (et) et.value = "";
      // reset switches
      document.querySelectorAll('.cond-toggle[data-type="neuf"][data-value="oui"], .cond-toggle[data-type="usite"][data-value="oui"]').forEach(x=>x.checked=false);
      document.querySelectorAll('.cond-toggle[data-type="neuf"][data-value="non"], .cond-toggle[data-type="usite"][data-value="non"]').forEach(x=>x.checked=true);
    });

    document.addEventListener("DOMContentLoaded", renderRefDatalist);
  </script>
</body>
</html>
