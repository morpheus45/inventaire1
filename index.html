<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1d4ed8" />
  <title>Gestion d'Inventaire ‚Äì Bon de sortie / retour</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --blue:#1d4ed8;
      --green:#16a34a;
      --red:#dc2626;
      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(17,24,39,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0b1220 0%, #0b1220 60%, rgba(11,18,32,0) 100%);padding:14px 14px 10px}
    header .bar{display:flex;gap:10px;align-items:center;color:#fff}
    header .logo{width:38px;height:38px;border-radius:12px;background:#0ea5e9;display:flex;align-items:center;justify-content:center;font-weight:800}
    header h1{font-size:18px;margin:0}
    header .sub{font-size:12px;color:rgba(255,255,255,.75);margin:2px 0 0}
    .wrap{max-width:980px;margin:0 auto;padding:12px 14px 24px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:860px){ .row{grid-template-columns:1fr 1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select, textarea{
      width:100%;padding:11px 12px;border:1px solid var(--border);
      border-radius:14px;background:#fff;font-size:15px;outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .btns{display:flex;flex-wrap:wrap;gap:10px}
    button{
      border:0;border-radius:14px;padding:12px 14px;font-size:15px;
      cursor:pointer;box-shadow:0 8px 18px rgba(17,24,39,.10);
      display:inline-flex;align-items:center;gap:10px;
    }
    .primary{background:var(--blue);color:#fff}
    .ghost{background:#eef2ff;color:#111827}
    .success{background:var(--green);color:#fff}
    .danger{background:#fee2e2;color:#7f1d1d}
    .small{font-size:13px;padding:10px 12px;border-radius:12px;box-shadow:none}
    .hint{color:var(--muted);font-size:12px;line-height:1.35}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{background:#fff;border:1px solid var(--border);border-radius:16px;padding:10px 12px;cursor:pointer}
    .tab.active{border-color:#93c5fd;box-shadow:0 10px 30px rgba(37,99,235,.10)}
    .hidden{display:none}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:14px;vertical-align:top}
    th{color:var(--muted);font-size:12px;font-weight:600}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;background:#f3f4f6;color:#111827;font-size:12px}
    .x{font-weight:800}
    .right{display:flex;justify-content:flex-end}
    .inline{display:flex;gap:10px;align-items:center}
    .inline > *{flex:1}
  
/* --- Statut NEUF / USIT√â (style "cartes" + interrupteurs) --- */
.status-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
}
.status-card{
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px 12px 10px 12px;
  background:#fff;
}
.status-neuf{ background:#eef5ff; }
.status-usite{ background:#fff6dd; }
.status-title{
  font-weight:800;
  letter-spacing:.4px;
  margin-bottom:8px;
}
.status-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:6px 0;
  border-top:1px dashed rgba(0,0,0,.08);
}
.status-row:first-of-type{ border-top:none; }
.switch{ position:relative; display:inline-block; width:46px; height:26px; }
.switch input{ opacity:0; width:0; height:0; }
.slider{
  position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
  background:#cfcfcf; transition:.2s; border-radius:999px;
}
.slider:before{
  position:absolute; content:""; height:20px; width:20px; left:3px; bottom:3px;
  background:white; transition:.2s; border-radius:50%;
}
.switch input:checked + .slider{ background:#2563eb; }
.switch input:checked + .slider:before{ transform:translateX(20px); }

/* IA thumbs in R√©f√©rences */
.ref-thumb{
  width:52px;height:52px;
  border-radius:12px;
  object-fit:cover;
  border:1px solid #e5e7eb;
  background:#f3f4f6;
}

</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">üì¶</div>
    <div>
      <h1>Gestion d'Inventaire</h1>
      <div class="sub">Bon de sortie / retour de stock ‚Äî conforme (2 bons sur 1 A4)</div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="tabs">
    <div class="tab active" data-tab="bon">üßæ Nouveau Bon</div>
    <div class="tab" data-tab="hist">üïò Historique</div>
    <div class="tab" data-tab="refs">üì¶ R√©f√©rences</div>
    <div class="tab" data-tab="codes">üè¨ Magasins</div>
  </div>

  <div class="grid" style="margin-top:12px">
    <!-- BON -->
    <section class="card" id="tab-bon">
      <div class="row">
        <div>
          <label>√âmetteur (code technicien)</label>
          <select id="emetteur"></select>
        </div>
        <div>
          <label>Magasin (code magasin)</label>
          <select id="magasin"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Destinataire</label>
          <input id="destinataire" value="STOCK CENTRAL" />
        </div>
        <div>
          <label>Date</label>
          <input id="date" type="date" />
        </div>
      </div>

      <hr style="border:none;border-top:1px solid var(--border);margin:14px 0" />

      <div class="card" style="box-shadow:none;padding:12px;border-radius:16px">
        <div class="inline">
          <div>
            <label>R√©f√©rence article</label>
            <select id="refSelect"></select>
          </div>
          <div style="max-width:140px">
            <label>Qt√©</label>
            <input id="qtyInput" type="number" min="1" step="1" value="1" />
          </div>
        </div>

        
<div class="status-grid" style="margin-top:10px">
  <div class="status-card status-neuf">
    <div class="status-title">NEUF</div>
    <div class="status-row"><span>Oui</span>
      <label class="switch"><input type="checkbox" id="neufOui"><span class="slider"></span></label>
    </div>
    <div class="status-row"><span>Non</span>
      <label class="switch"><input type="checkbox" id="neufNon"><span class="slider"></span></label>
    </div>
  </div>

  <div class="status-card status-usite">
    <div class="status-title">USIT√â</div>
    <div class="status-row"><span>Oui</span>
      <label class="switch"><input type="checkbox" id="usiteOui"><span class="slider"></span></label>
    </div>
    <div class="status-row"><span>Non</span>
      <label class="switch"><input type="checkbox" id="usiteNon"><span class="slider"></span></label>
    </div>
  </div>
</div>

<input type="hidden" id="neufSelect" value="non">
<input type="hidden" id="usiteSelect" value="non">

<label>Commentaire (optionnel)</label>
          <input id="commentInput" placeholder="Ex: HS, retour, etc." />
        </div>

        <div class="btns" style="margin-top:12px">
          <button class="success" id="btnAdd">‚úÖ Valider l‚Äôarticle</button>
          <button class="ghost small" id="btnClearLine">Effacer la saisie</button>
        </div>

        <div class="hint" style="margin-top:10px">
          Astuce : la r√©f√©rence reste modifiable (tu peux la corriger avant de valider).
        </div>
      </div>

      <div style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>R√©f√©rence</th>
              <th>Qt√©</th>
              <th>Neuf</th>
              <th>Usit√©</th>
              <th>Commentaire</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="lines"></tbody>
        </table>
        <div class="hint" id="limitHint" style="margin-top:8px"></div>
      </div>

      <div style="margin-top:12px">
        <label>Observations</label>
        <textarea id="observations" placeholder="Notes ou observations‚Ä¶"></textarea>
      </div>

      <div class="btns" style="margin-top:14px">
        <button class="primary" id="btnPdf">‚¨áÔ∏è Exporter PDF (2 bons sur 1 A4)</button>
        <button class="ghost" id="btnShare">üì≤ Partager le PDF</button>
        <button class="ghost" id="btnSaveDraft">üíæ √âconomiser (brouillon)</button>
        <button class="danger" id="btnNew">üóëÔ∏è Nouveau bon</button>
      </div>

      <div class="hint" style="margin-top:10px">
        Important : chaque export PDF cr√©e un <b>nouveau num√©ro de bon</b> (unique sur cet appareil via localStorage).
      </div>
    </section>

    <!-- HISTORIQUE -->
    <section class="card hidden" id="tab-hist">
      <div class="btns" style="margin-bottom:10px">
        <button class="ghost" id="btnRefreshHist">üîÑ Actualiser</button>
        <button class="danger" id="btnClearHist">üóëÔ∏è Vider l‚Äôhistorique</button>
      </div>
      <div id="histWrap" class="hint"></div>
    </section>

    <!-- REFERENCES -->
    <section class="card hidden" id="tab-refs">
      <div class="row">
        <div>
          <label>Ajouter une r√©f√©rence</label>
          <input id="newRef" placeholder="Ex: IR CO8 54" />
        </div>
        <div class="right" style="align-items:end">
          <button class="success" id="btnAddRef">‚ûï Ajouter</button>
        </div>
      </div>
      <div class="hint" style="margin-top:6px">Les r√©f√©rences sont enregistr√©es localement (sur cet appareil).</div>

      <!-- IA : acc√®s rapide (si le module IA est pr√©sent) -->
      <div class="btns" id="iaRefsBtns" style="margin-top:10px; display:none">
        <button class="ghost" id="btnIAOpenScan">ü§ñ IA photo (d√©tection)</button>
        <button class="ghost" id="btnIAOpenBase">üìö Base IA (photos par ref)</button>
      </div>
      <div style="margin-top:12px">
        <table>
          <thead><tr><th>R√©f√©rence</th><th></th></tr></thead>
          <tbody id="refsTable"></tbody>
        </table>
      </div>
    </section>

    <!-- MAGASINS -->
    <section class="card hidden" id="tab-codes">
      <div class="row">
        <div>
          <label>Ajouter un magasin (code + libell√©)</label>
          <input id="newMagCode" placeholder="Ex: ISTGS55" />
        </div>
        <div>
          <label>Libell√©</label>
          <input id="newMagLabel" placeholder="Ex: Jean Robert" />
        </div>
      </div>
      <div class="btns" style="margin-top:10px">
        <button class="success" id="btnAddMag">‚ûï Ajouter</button>
      </div>
      <div class="hint" style="margin-top:6px">Les magasins sont enregistr√©s localement (sur cet appareil).</div>

      <div style="margin-top:12px">
        <table>
          <thead><tr><th>Code</th><th>Libell√©</th><th></th></tr></thead>
          <tbody id="magTable"></tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<!-- jsPDF (UMD) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>

<script>
/* --------------------- Storage keys --------------------- */
const K = {
  refs: "inv_refs_v1",
  mags: "inv_mags_v1",
  emit: "inv_emit_v1",
  draft: "inv_draft_v1",
  hist: "inv_hist_v1",
  seq: "inv_bon_seq_v1"
};

const DEFAULT_EMETTEURS = [
  { code: "ISTGS54", label: "ISTGS54" }
];

const DEFAULT_MAGS = [
  { code: "ISTGS54", label: "Magasin principal" },
  { code: "ISTGS55", label: "Jean Robert" }
];

const DEFAULT_REFS = [
  "IR CO8 52","IR CO8 54","IR CO8 71","IR CO8 72",
  "IR CO9 03","IR CO8 03","IR CRP 02","CO CRP 02",
  "SF CO8 11","SJ CO8 12","SJ ?? 12","CZ CO8 12"
].filter(Boolean);

/* --------------------- State --------------------- */
let lines = []; // {ref, qty, neufOui, usiteOui, comment}

/* --------------------- Helpers --------------------- */
const $ = (id) => document.getElementById(id);

function loadJSON(key, fallback){
  try{
    const v = localStorage.getItem(key);
    if(!v) return fallback;
    return JSON.parse(v);
  }catch(e){ return fallback; }
}
function saveJSON(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

function todayISO(){
  const d = new Date();
  const pad = (n) => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function ensureSeq(){
  let seq = Number(localStorage.getItem(K.seq) || "0");
  if(!seq || seq < 1000000){
    // base unique-ish
    seq = Math.floor((Date.now()/1000) % 9000000) + 1000000;
    localStorage.setItem(K.seq, String(seq));
  }
  return seq;
}
function nextBonNumber(){
  const seq = ensureSeq() + 1;
  localStorage.setItem(K.seq, String(seq));
  return String(seq).padStart(7,"0");
}

function sanitizeRef(s){
  return (s || "").trim().replace(/\s+/g," ");
}

/* --------------------- Tabs --------------------- */
document.querySelectorAll(".tab").forEach(t => {
  t.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    t.classList.add("active");
    const name = t.dataset.tab;
    ["bon","hist","refs","codes"].forEach(k => $("tab-"+k).classList.add("hidden"));
    $("tab-"+name).classList.remove("hidden");
    if(name === "hist") renderHist();
    if(name === "refs") renderRefs();
    if(name === "codes") renderMags();
  });
});

/* --------------------- Init selects --------------------- */
function fillSelect(sel, arr){
  sel.innerHTML = "";
  arr.forEach(o => {
    const opt = document.createElement("option");
    opt.value = o.code;
    opt.textContent = o.label ? `${o.code} ‚Äî ${o.label}` : o.code;
    sel.appendChild(opt);
  });
}

function initData(){
  const refs = loadJSON(K.refs, null) || DEFAULT_REFS;
  const mags = loadJSON(K.mags, null) || DEFAULT_MAGS;
  const emit = loadJSON(K.emit, null) || DEFAULT_EMETTEURS;

  saveJSON(K.refs, refs);
  saveJSON(K.mags, mags);
  saveJSON(K.emit, emit);

  fillSelect($("emetteur"), emit);
  fillSelect($("magasin"), mags);

  // Menu d√©roulant des r√©f√©rences
  const refSel = $("refSelect");
  refSel.innerHTML = `<option value="" disabled selected>Choisir une r√©f√©rence...</option>` +
    refs.map(r => `<option value="${r.replaceAll('"','&quot;')}">${escapeHTML(r)}</option>`).join("");

  // L‚Äô√©metteur doit correspondre au magasin
  $("magasin").addEventListener("change", () => { $("emetteur").value = $("magasin").value; });
  // init: aligne au chargement
  $("emetteur").value = $("magasin").value;

  // Interrupteurs NEUF / USIT√â
  function setNeuf(v){
    const yes = (v === "oui");
    $("neufOui").checked = yes; $("neufNon").checked = !yes;
    $("neufSelect").value = v;
    if(yes) setUsite("non");
  }
  function setUsite(v){
    const yes = (v === "oui");
    $("usiteOui").checked = yes; $("usiteNon").checked = !yes;
    $("usiteSelect").value = v;
    if(yes) setNeuf("non");
  }
  // valeurs par d√©faut
  setNeuf("non");
  setUsite("non");
  $("neufOui").addEventListener("change", () => setNeuf($("neufOui").checked ? "oui" : "non"));
  $("neufNon").addEventListener("change", () => setNeuf($("neufNon").checked ? "non" : "oui"));
  $("usiteOui").addEventListener("change", () => setUsite($("usiteOui").checked ? "oui" : "non"));
  $("usiteNon").addEventListener("change", () => setUsite($("usiteNon").checked ? "non" : "oui"));

}

/* --------------------- Lines rendering --------------------- */
function renderLines(){
  const tbody = $("lines");
  tbody.innerHTML = "";
  lines.forEach((l, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHTML(l.ref)}</td>
      <td><span class="pill">x${l.qty}</span></td>
      <td>${l.neufOui ? "<span class='x'>X</span>" : ""}</td>
      <td>${l.usiteOui ? "<span class='x'>X</span>" : ""}</td>
      <td>${escapeHTML(l.comment || "")}</td>
      <td class="right"><button class="danger small" data-del="${idx}">Supprimer</button></td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button[data-del]").forEach(b => {
    b.addEventListener("click", () => {
      const i = Number(b.dataset.del);
      lines.splice(i,1);
      renderLines();
    });
  });

  const limit = 10;
  $("limitHint").textContent = lines.length > limit
    ? `‚ö†Ô∏è ${lines.length} lignes : le PDF n'affichera que les ${limit} premi√®res (limite du formulaire).`
    : `Limite PDF : ${limit} lignes (comme sur le bon papier).`;
}

function escapeHTML(s){
  return (s || "").replace(/[&<>"]/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}

/* --------------------- Add line --------------------- */
$("btnAdd").addEventListener("click", () => {
  const ref = sanitizeRef($("refSelect").value);
  if(!ref){
    alert("Renseigne une r√©f√©rence.");
    return;
  }
  const qty = Math.max(1, parseInt($("qtyInput").value || "1", 10));
  const neufOui = $("neufSelect").value === "oui";
  const usiteOui = $("usiteSelect").value === "oui";
  const comment = sanitizeRef($("commentInput").value);

  lines.push({ ref, qty, neufOui, usiteOui, comment });
  renderLines();

  // auto-save reference if new
  const refs = loadJSON(K.refs, []);
  if(!refs.includes(ref)){
    refs.unshift(ref);
    saveJSON(K.refs, refs.slice(0,200));
    // Menu d√©roulant des r√©f√©rences
  const refSel = $("refSelect");
  refSel.innerHTML = `<option value="" disabled selected>Choisir une r√©f√©rence...</option>` +
    refs.map(r => `<option value="${r.replaceAll('"','&quot;')}">${escapeHTML(r)}</option>`).join("");

  // L‚Äô√©metteur doit correspondre au magasin
  $("magasin").addEventListener("change", () => { $("emetteur").value = $("magasin").value; });
  // init: aligne au chargement
  $("emetteur").value = $("magasin").value;

  // Interrupteurs NEUF / USIT√â
  function setNeuf(v){
    const yes = (v === "oui");
    $("neufOui").checked = yes; $("neufNon").checked = !yes;
    $("neufSelect").value = v;
    if(yes) setUsite("non");
  }
  function setUsite(v){
    const yes = (v === "oui");
    $("usiteOui").checked = yes; $("usiteNon").checked = !yes;
    $("usiteSelect").value = v;
    if(yes) setNeuf("non");
  }
  // valeurs par d√©faut
  setNeuf("non");
  setUsite("non");
  $("neufOui").addEventListener("change", () => setNeuf($("neufOui").checked ? "oui" : "non"));
  $("neufNon").addEventListener("change", () => setNeuf($("neufNon").checked ? "non" : "oui"));
  $("usiteOui").addEventListener("change", () => setUsite($("usiteOui").checked ? "oui" : "non"));
  $("usiteNon").addEventListener("change", () => setUsite($("usiteNon").checked ? "non" : "oui"));

  }

  $("refSelect").selectedIndex = 0;
  $("qtyInput").value = "1";
  $("commentInput").value = "";
  $("neufSelect").value = "non";
  $("usiteSelect").value = "non";
});

$("btnClearLine").addEventListener("click", () => {
  $("refSelect").selectedIndex = 0;
  $("qtyInput").value = "1";
  $("commentInput").value = "";
  $("neufSelect").value = "non";
  $("usiteSelect").value = "non";
  if ($("neufOui")) { $("neufOui").checked = false; $("neufNon").checked = true; }
  if ($("usiteOui")) { $("usiteOui").checked = false; $("usiteNon").checked = true; }
});

/* --------------------- Draft / new --------------------- */
$("btnSaveDraft").addEventListener("click", () => {
  const draft = collectBon(false);
  saveJSON(K.draft, draft);
  alert("Brouillon enregistr√©.");
});

$("btnNew").addEventListener("click", () => {
  if(confirm("Cr√©er un nouveau bon ? (le brouillon actuel ne sera pas supprim√©)")){
    lines = [];
    $("observations").value = "";
    $("destinataire").value = "STOCK CENTRAL";
    $("date").value = todayISO();
    renderLines();
  }
});

function collectBon(assignNumber){
  return {
    bonNumber: assignNumber ? nextBonNumber() : null,
    emetteur: $("emetteur").value,
    magasin: $("magasin").value,
    destinataire: sanitizeRef($("destinataire").value) || "STOCK CENTRAL",
    date: $("date").value || todayISO(),
    observations: $("observations").value || "",
    lines: lines.slice(0, 10) // PDF limit
  };
}

function pushHistory(entry){
  const hist = loadJSON(K.hist, []);
  hist.unshift(entry);
  saveJSON(K.hist, hist.slice(0, 80));
}

/* --------------------- PDF drawing (jsPDF) --------------------- */
function drawBon(doc, y0, data){
  // A4: 210 x 297 mm. Half: 148.5 mm
  const X = 5;
  const Y = y0 + 5;
  const W = 200;
  const H = 138.5; // leave room inside half A4

  // Outer border
  doc.setDrawColor(0);
  doc.setLineWidth(0.2);
  doc.rect(X, Y, W, H);

  // Header band
  const headerH = 22;
  doc.setFillColor(240,240,240);
  doc.rect(X, Y, W, headerH, "F");
  doc.rect(X, Y, W, headerH);

  // Logo box (approx. "eps")
  doc.setFillColor(180,180,180);
  doc.rect(X+2, Y+3, 26, 14, "F");
  doc.setTextColor(255,255,255);
  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text("eps", X+15, Y+14, {align:"center"});
  doc.setTextColor(0,0,0);

  // Title & subtitle
  doc.setFont("helvetica","bold");
  doc.setFontSize(12);
  doc.text("BON DE SORTIE DE STOCK N¬∞", X+32, Y+9);
  doc.setFont("helvetica","normal");
  doc.setFontSize(7.5);
  doc.text("A JOINDRE IMP√âRATIVEMENT √Ä TOUT RETOUR DU STOCK CENTRAL", X+32, Y+15);

  // Bon number box (red)
  doc.setDrawColor(0);
  doc.rect(X+W-44, Y+4, 42, 14);
  doc.setTextColor(200,0,0);
  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text(data.bonNumber, X+W-23, Y+15, {align:"center"});
  doc.setTextColor(0,0,0);

  // Info fields
  const infoY = Y + headerH + 4;
  doc.setFontSize(8.5);
  doc.setFont("helvetica","bold");
  doc.text("√âMETTEUR :", X+2, infoY);
  doc.setFont("helvetica","normal");
  doc.text(data.emetteur, X+22, infoY);
  doc.setFontSize(7);
  doc.text("(Code technicien)", X+22, infoY+4);

  doc.setFontSize(8.5);
  doc.setFont("helvetica","bold");
  doc.text("MAGASIN :", X+2, infoY+10);
  doc.setFont("helvetica","normal");
  doc.text(data.magasin, X+22, infoY+10);
  doc.setFontSize(7);
  doc.text("(Code magasin)", X+22, infoY+14);

  doc.setFontSize(8.5);
  doc.setFont("helvetica","bold");
  doc.text("DESTINATAIRE :", X+110, infoY);
  doc.setFont("helvetica","normal");
  doc.text(data.destinataire, X+138, infoY);

  doc.setFont("helvetica","bold");
  doc.text("DATE :", X+110, infoY+10);
  doc.setFont("helvetica","normal");
  doc.text(data.date.split("-").reverse().join("/"), X+122, infoY+10);

  // Table
  const tableY = infoY + 18;
  const rowH = 8;
  const header1H = 8;
  const header2H = 7;

  const cRef = 92;
  const cYN = 9; // each Oui/Non column
  const cComm = W - (cRef + 4*cYN);

  // header rectangles
  doc.setFont("helvetica","bold");
  doc.setFontSize(8.5);
  // first header row (merged cells)
  doc.rect(X, tableY, cRef, header1H);
  doc.rect(X+cRef, tableY, 2*cYN, header1H);
  doc.rect(X+cRef+2*cYN, tableY, 2*cYN, header1H);
  doc.rect(X+cRef+4*cYN, tableY, cComm, header1H);

  doc.text("R√âF√âRENCE ARTICLE", X + cRef/2, tableY+5.5, {align:"center"});
  doc.text("NEUF", X + cRef + cYN, tableY+5.5, {align:"center"});
  doc.text("USIT√â", X + cRef + 3*cYN, tableY+5.5, {align:"center"});
  doc.text("COMMENTAIRES", X + cRef + 4*cYN + cComm/2, tableY+5.5, {align:"center"});

  // second header row (Oui/Non)
  const y2 = tableY + header1H;
  // ref col blank
  doc.rect(X, y2, cRef, header2H);
  // NEUF Oui / Non
  doc.rect(X+cRef, y2, cYN, header2H);
  doc.rect(X+cRef+cYN, y2, cYN, header2H);
  // USIT√â Oui / Non
  doc.rect(X+cRef+2*cYN, y2, cYN, header2H);
  doc.rect(X+cRef+3*cYN, y2, cYN, header2H);
  // comm
  doc.rect(X+cRef+4*cYN, y2, cComm, header2H);

  doc.setFontSize(7.5);
  doc.text("Oui", X+cRef + cYN/2, y2+5, {align:"center"});
  doc.text("Non", X+cRef + cYN + cYN/2, y2+5, {align:"center"});
  doc.text("Oui", X+cRef + 2*cYN + cYN/2, y2+5, {align:"center"});
  doc.text("Non", X+cRef + 3*cYN + cYN/2, y2+5, {align:"center"});

  // rows
  const startRowsY = y2 + header2H;
  doc.setFont("helvetica","normal");
  doc.setFontSize(8.5);
  const maxRows = 10;
  for(let i=0;i<maxRows;i++){
    const ry = startRowsY + i*rowH;
    doc.rect(X, ry, cRef, rowH);
    doc.rect(X+cRef, ry, cYN, rowH);
    doc.rect(X+cRef+cYN, ry, cYN, rowH);
    doc.rect(X+cRef+2*cYN, ry, cYN, rowH);
    doc.rect(X+cRef+3*cYN, ry, cYN, rowH);
    doc.rect(X+cRef+4*cYN, ry, cComm, rowH);

    const l = data.lines[i];
    if(l){
      doc.text(l.ref, X+2, ry+5.5);
      const mark = "X";
      // Neuf
      if(l.neufOui) doc.text(mark, X+cRef + cYN/2, ry+5.5, {align:"center"});
      else doc.text(mark, X+cRef + cYN + cYN/2, ry+5.5, {align:"center"});
      // Usit√©
      if(l.usiteOui) doc.text(mark, X+cRef + 2*cYN + cYN/2, ry+5.5, {align:"center"});
      else doc.text(mark, X+cRef + 3*cYN + cYN/2, ry+5.5, {align:"center"});

      const comm = `x${l.qty}` + (l.comment ? ` ${l.comment}` : "");
      doc.text(comm, X+cRef+4*cYN + 2, ry+5.5);
    }
  }

  // Observations
  const obsY = startRowsY + maxRows*rowH + 6;
  doc.setFont("helvetica","bold");
  doc.setFontSize(8.5);
  doc.text("Observations :", X+2, obsY);

  const obsBoxY = obsY + 2;
  const obsBoxH = Y + H - obsBoxY - 4;
  doc.setFont("helvetica","normal");
  doc.setFontSize(8.5);
  doc.rect(X, obsBoxY, W, obsBoxH);
  const obsText = (data.observations || "").trim();
  if(obsText){
    const wrapped = doc.splitTextToSize(obsText, W-4);
    doc.text(wrapped.slice(0,5), X+2, obsBoxY+6); // limit lines to keep clean
  }
}

async function buildPDF(twoCopies=true){
  if(!window.jspdf || !window.jspdf.jsPDF){
    alert("Librairie PDF non charg√©e (jsPDF). V√©rifie ta connexion et recharge la page.");
    return null;
  }
  const data = collectBon(true);
  if(data.lines.length === 0){
    alert("Ajoute au moins une r√©f√©rence avant d'exporter.");
    return null;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"portrait", unit:"mm", format:"a4"});

  // Draw 2 copies on the same A4
  drawBon(doc, 0, data);
  drawBon(doc, 148.5, data);

  // History
  pushHistory({
    ...data,
    createdAt: new Date().toISOString()
  });

  return { doc, bonNumber: data.bonNumber };
}

$("btnPdf").addEventListener("click", async () => {
  const res = await buildPDF(true);
  if(!res) return;
  res.doc.save(`bon_sortie_${res.bonNumber}.pdf`);
});

$("btnShare").addEventListener("click", async () => {
  const res = await buildPDF(true);
  if(!res) return;

  const blob = res.doc.output("blob");
  const file = new File([blob], `bon_sortie_${res.bonNumber}.pdf`, { type: "application/pdf" });

  if(navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
    try{
      await navigator.share({ title: "Bon de sortie / retour", files: [file] });
    }catch(e){
      // user cancelled
    }
  }else{
    // fallback: download
    res.doc.save(`bon_sortie_${res.bonNumber}.pdf`);
    alert("Partage non support√© ici : le PDF a √©t√© t√©l√©charg√© (ouvre-le puis partage depuis ton t√©l√©phone).");
  }
});

/* --------------------- Historique --------------------- */
function renderHist(){
  const hist = loadJSON(K.hist, []);
  if(hist.length === 0){
    $("histWrap").innerHTML = "Aucun bon export√© pour le moment.";
    return;
  }
  const rows = hist.map(h => {
    const dt = (h.date || "").split("-").reverse().join("/");
    return `<div style="padding:10px 0;border-bottom:1px solid var(--border)">
      <div><b>N¬∞ ${h.bonNumber}</b> ‚Äî ${escapeHTML(h.magasin)} ‚Üí ${escapeHTML(h.destinataire)} ‚Äî ${dt}</div>
      <div class="hint">${h.lines.length} ligne(s) ‚Äî ${escapeHTML((h.createdAt||"").replace("T"," ").slice(0,19))}</div>
    </div>`;
  }).join("");
  $("histWrap").innerHTML = rows;
}

$("btnRefreshHist").addEventListener("click", renderHist);
$("btnClearHist").addEventListener("click", () => {
  if(confirm("Supprimer l'historique local ?")){
    localStorage.removeItem(K.hist);
    renderHist();
  }
});

/* --------------------- R√©f√©rences --------------------- */
async function renderRefs(){
  const refs = loadJSON(K.refs, []);
  const tbody = $("refsTable");
  tbody.innerHTML = "";

  // IA present? Show quick access buttons in this tab
  const iaOk = !!(window.AIRefAddon && typeof window.AIRefAddon.openScan === "function");
  const iaBtns = $("iaRefsBtns");
  if (iaBtns) iaBtns.style.display = iaOk ? "flex" : "none";
  if (iaOk) {
    $("btnIAOpenScan").onclick = () => window.AIRefAddon.openScan();
    $("btnIAOpenBase").onclick = () => window.AIRefAddon.openBase();
  }

  // Pull thumbs/counts from IA photo base (if available)
  let summary = {};
  if (window.AIRefAddon && typeof window.AIRefAddon.getRefSummary === "function") {
    try { summary = await window.AIRefAddon.getRefSummary(); } catch { summary = {}; }
  }

  refs.forEach((r, idx) => {
    const sum = summary[r] || { count: 0, thumb: null };
    const thumb = sum.thumb
      ? `<img class="ref-thumb" src="${sum.thumb}" alt="photo IA" />`
      : `<span class="hint" style="white-space:nowrap">Aucune photo IA</span>`;
    const countHint = `<div class="hint" style="margin-top:2px">${sum.count || 0} photo(s) IA</div>`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div class="row" style="align-items:center; gap:10px">
          <div style="flex:1; min-width:0">
            <div><b>${escapeHTML(r)}</b></div>
            ${countHint}
          </div>
          <div class="right" style="min-width:70px">${thumb}</div>
        </div>
      </td>
      <td class="right">
        <button class="ghost small" data-iaref="${idx}" ${iaOk ? "" : "disabled"}>üì∑ IA</button>
        <button class="danger small" data-rdel="${idx}">Supprimer</button>
      </td>`;
    tbody.appendChild(tr);
  });

  // Delete ref
  tbody.querySelectorAll("button[data-rdel]").forEach(b => {
    b.addEventListener("click", () => {
      const refs2 = loadJSON(K.refs, []);
      refs2.splice(Number(b.dataset.rdel),1);
      saveJSON(K.refs, refs2);
      renderRefs();
      // Menu d√©roulant des r√©f√©rences (apr√®s ajout/suppression)
      const refSel2 = $("refSelect");
      const opts = `<option value="" disabled selected>Choisir une r√©f√©rence...</option>` +
        refs2.map(r => `<option value="${r.replaceAll('"','&quot;')}">${escapeHTML(r)}</option>`).join("");
      refSel2.innerHTML = opts;
    });
  });

  // Open IA base on a specific reference
  tbody.querySelectorAll("button[data-iaref]").forEach(b => {
    b.addEventListener("click", () => {
      if (!window.AIRefAddon || typeof window.AIRefAddon.openBase !== "function") return;
      const ref = refs[Number(b.dataset.iaref)];
      window.AIRefAddon.openBase(ref);
    });
  });
}
$("btnAddRef").addEventListener("click", () => {
  const r = sanitizeRef($("newRef").value);
  if(!r) return;
  const refs = loadJSON(K.refs, []);
  if(!refs.includes(r)) refs.unshift(r);
  saveJSON(K.refs, refs.slice(0,200));
  $("newRef").value = "";
  renderRefs();
  // Menu d√©roulant des r√©f√©rences
  const refSel = $("refSelect");
  refSel.innerHTML = `<option value="" disabled selected>Choisir une r√©f√©rence...</option>` +
    refs.map(r => `<option value="${r.replaceAll('"','&quot;')}">${escapeHTML(r)}</option>`).join("");

  // L‚Äô√©metteur doit correspondre au magasin
  $("magasin").addEventListener("change", () => { $("emetteur").value = $("magasin").value; });
  // init: aligne au chargement
  $("emetteur").value = $("magasin").value;

  // Interrupteurs NEUF / USIT√â
  function setNeuf(v){
    const yes = (v === "oui");
    $("neufOui").checked = yes; $("neufNon").checked = !yes;
    $("neufSelect").value = v;
    if(yes) setUsite("non");
  }
  function setUsite(v){
    const yes = (v === "oui");
    $("usiteOui").checked = yes; $("usiteNon").checked = !yes;
    $("usiteSelect").value = v;
    if(yes) setNeuf("non");
  }
  // valeurs par d√©faut
  setNeuf("non");
  setUsite("non");
  $("neufOui").addEventListener("change", () => setNeuf($("neufOui").checked ? "oui" : "non"));
  $("neufNon").addEventListener("change", () => setNeuf($("neufNon").checked ? "non" : "oui"));
  $("usiteOui").addEventListener("change", () => setUsite($("usiteOui").checked ? "oui" : "non"));
  $("usiteNon").addEventListener("change", () => setUsite($("usiteNon").checked ? "non" : "oui"));

});

/* --------------------- Magasins --------------------- */
function renderMags(){
  const mags = loadJSON(K.mags, []);
  const tbody = $("magTable");
  tbody.innerHTML = "";
  mags.forEach((m, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHTML(m.code)}</td>
      <td>${escapeHTML(m.label || "")}</td>
      <td class="right"><button class="danger small" data-mdel="${idx}">Supprimer</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("button[data-mdel]").forEach(b => {
    b.addEventListener("click", () => {
      const mags2 = loadJSON(K.mags, []);
      mags2.splice(Number(b.dataset.mdel),1);
      saveJSON(K.mags, mags2);
      fillSelect($("magasin"), mags2);
      renderMags();
    });
  });
}
$("btnAddMag").addEventListener("click", () => {
  const code = sanitizeRef($("newMagCode").value).toUpperCase();
  const label = sanitizeRef($("newMagLabel").value);
  if(!code) return;
  const mags = loadJSON(K.mags, []);
  if(mags.some(m => m.code === code)){
    alert("Ce code magasin existe d√©j√†.");
    return;
  }
  mags.unshift({ code, label });
  saveJSON(K.mags, mags);
  fillSelect($("magasin"), mags);
  $("newMagCode").value = "";
  $("newMagLabel").value = "";
  renderMags();
});

/* --------------------- Service Worker --------------------- */
if("serviceWorker" in navigator){
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js").catch(()=>{});
  });
}

/* --------------------- Boot --------------------- */
initData();
$("date").value = todayISO();

// restore draft if exists
const draft = loadJSON(K.draft, null);
if(draft){
  try{
    $("emetteur").value = draft.emetteur || $("emetteur").value;
    $("magasin").value = draft.magasin || $("magasin").value;
    $("destinataire").value = draft.destinataire || "STOCK CENTRAL";
    $("date").value = draft.date || todayISO();
    $("observations").value = draft.observations || "";
    lines = Array.isArray(draft.lines) ? draft.lines : [];
    renderLines();
  }catch(e){}
}else{
  renderLines();
}
</script>

<!-- IA Photo (optionnel) : module autonome, n'impacte pas le fonctionnement manuel -->
<script>
  window.AI_REF_ADDON_CONFIG = {
    // Si vide, le module IA r√©cup√®re la liste dans l'onglet R√©f√©rences
    refs: [],
    // Seuils de confiance : au-dessus -> auto ; sinon -> demande validation
    threshold_auto: 0.78,
    threshold_min: 0.55,
    // Nombre max d'objets √† traiter (photo de lot)
    max_objects: 20,
    // Stockage
    db_name: "inventaire_ai_ref_db",
    // Debug (console)
    debug: false
  };
</script>
<script src="./ai/ai.js"></script>
</body>
</html>
