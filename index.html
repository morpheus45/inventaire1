<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1d4ed8" />
  <title>Gestion d'Inventaire ‚Äì Bon de sortie / retour</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --blue:#1d4ed8;
      --green:#16a34a;
      --red:#dc2626;
      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(17,24,39,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0b1220 0%, #0b1220 60%, rgba(11,18,32,0) 100%);padding:14px 14px 10px}
    header .bar{display:flex;gap:10px;align-items:center;color:#fff}
    header .logo{width:38px;height:38px;border-radius:12px;background:#0ea5e9;display:flex;align-items:center;justify-content:center;font-weight:800}
    header h1{font-size:18px;margin:0}
    header .sub{font-size:12px;color:rgba(255,255,255,.75);margin:2px 0 0}
    .wrap{max-width:980px;margin:0 auto;padding:12px 14px 24px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:860px){ .row{grid-template-columns:1fr 1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select, textarea{
      width:100%;padding:11px 12px;border:1px solid var(--border);
      border-radius:14px;background:#fff;font-size:15px;outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .btns{display:flex;flex-wrap:wrap;gap:10px}
    button{
      border:0;border-radius:14px;padding:12px 14px;font-size:15px;
      cursor:pointer;box-shadow:0 8px 18px rgba(17,24,39,.10);
      display:inline-flex;align-items:center;gap:10px;
    }
    .primary{background:var(--blue);color:#fff}
    .ghost{background:#eef2ff;color:#111827}
    .success{background:var(--green);color:#fff}
    .danger{background:#fee2e2;color:#7f1d1d}
    .small{font-size:13px;padding:10px 12px;border-radius:12px;box-shadow:none}
    .hint{color:var(--muted);font-size:12px;line-height:1.35}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{background:#fff;border:1px solid var(--border);border-radius:16px;padding:10px 12px;cursor:pointer}
    .tab.active{border-color:#93c5fd;box-shadow:0 10px 30px rgba(37,99,235,.10)}
    .hidden{display:none}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:14px;vertical-align:top}
    th{color:var(--muted);font-size:12px;font-weight:600}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;background:#f3f4f6;color:#111827;font-size:12px}
    .x{font-weight:800}
    .right{display:flex;justify-content:flex-end}
    .inline{display:flex;gap:10px;align-items:center}
    .inline > *{flex:1}
  
/* --- Statut NEUF / USIT√â (style "cartes" + interrupteurs) --- */
.status-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
}
.status-card{
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px 12px 10px 12px;
  background:#fff;
}
.status-neuf{ background:#eef5ff; }
.status-usite{ background:#fff6dd; }
.status-title{
  font-weight:800;
  letter-spacing:.4px;
  margin-bottom:8px;
}
.status-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:6px 0;
  border-top:1px dashed rgba(0,0,0,.08);
}
.status-row:first-of-type{ border-top:none; }
.switch{ position:relative; display:inline-block; width:46px; height:26px; }
.switch input{ opacity:0; width:0; height:0; }
.slider{
  position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
  background:#cfcfcf; transition:.2s; border-radius:999px;
}
.slider:before{
  position:absolute; content:""; height:20px; width:20px; left:3px; bottom:3px;
  background:white; transition:.2s; border-radius:50%;
}
.switch input:checked + .slider{ background:#2563eb; }
.switch input:checked + .slider:before{ transform:translateX(20px); }

/* IA thumbs in R√©f√©rences */
.ref-thumb{
  width:52px;height:52px;
  border-radius:12px;
  object-fit:cover;
  border:1px solid #e5e7eb;
  background:#f3f4f6;
}

</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">üì¶</div>
    <div>
      <h1>Gestion d'Inventaire</h1>
      <div class="sub">Bon de sortie / retour de stock ‚Äî conforme (2 bons sur 1 A4)</div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="tabs">
    <div class="tab active" data-tab="bon">üßæ Nouveau Bon</div>
    <div class="tab" data-tab="hist">üïò Historique</div>
    <div class="tab" data-tab="refs">üì¶ R√©f√©rences</div>
    <div class="tab" data-tab="codes">üè¨ Magasins</div>
  </div>

  <div class="grid" style="margin-top:12px">
    <!-- BON -->
    <section class="card" id="tab-bon">
      <div class="row">
        <div>
          <label>√âmetteur (code technicien)</label>
          <select id="emetteur"></select>
        </div>
        <div>
          <label>Magasin (code magasin)</label>
          <select id="magasin"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Destinataire</label>
          <input id="destinataire" value="STOCK CENTRAL" />
        </div>
        <div>
          <label>Date</label>
          <input id="date" type="date" />
        </div>
      </div>

      <hr style="border:none;border-top:1px solid var(--border);margin:14px 0" />

      <div class="card" style="box-shadow:none;padding:12px;border-radius:16px">
        <div class="inline">
          <div>
            <label>R√©f√©rence article</label>
            <select id="refSelect"></select>
          </div>
          <div style="max-width:140px">
            <label>Qt√©</label>
            <input id="qtyInput" type="number" min="1" step="1" value="1" />
          </div>
        </div>

        
<div class="status-grid" style="margin-top:10px">
  <div class="status-card status-neuf">
    <div class="status-title">NEUF</div>
    <div class="status-row"><span>Oui</span>
      <label class="switch"><input type="checkbox" id="neufOui"><span class="slider"></span></label>
    </div>
    <div class="status-row"><span>Non</span>
      <label class="switch"><input type="checkbox" id="neufNon"><span class="slider"></span></label>
    </div>
  </div>

  <div class="status-card status-usite">
    <div class="status-title">USIT√â</div>
    <div class="status-row"><span>Oui</span>
      <label class="switch"><input type="checkbox" id="usiteOui"><span class="slider"></span></label>
    </div>
    <div class="status-row"><span>Non</span>
      <label class="switch"><input type="checkbox" id="usiteNon"><span class="slider"></span></label>
    </div>
  </div>
</div>

<input type="hidden" id="neufSelect" value="non">
<input type="hidden" id="usiteSelect" value="non">

<label>Commentaire (optionnel)</label>
          <input id="commentInput" placeholder="Ex: HS, retour, etc." />
        </div>

        <div class="btns" style="margin-top:12px">
          <button class="success" id="btnAdd">‚úÖ Valider l‚Äôarticle</button>
          <button class="ghost small" id="btnClearLine">Effacer la saisie</button>
        </div>

        <div class="hint" style="margin-top:10px">
          Astuce : la r√©f√©rence reste modifiable (tu peux la corriger avant de valider).
        </div>
      </div>

      <div style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>R√©f√©rence</th>
              <th>Qt√©</th>
              <th>Neuf</th>
              <th>Usit√©</th>
              <th>Commentaire</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="lines"></tbody>
        </table>
        <div class="hint" id="limitHint" style="margin-top:8px"></div>
      </div>

      <div style="margin-top:12px">
        <label>Observations</label>
        <textarea id="observations" placeholder="Notes ou observations‚Ä¶"></textarea>
      </div>

      <div class="btns" style="margin-top:14px">
        <button class="primary" id="btnPdf">‚¨áÔ∏è Exporter PDF (2 bons sur 1 A4)</button>
        <button class="ghost" id="btnShare">üì≤ Partager le PDF</button>
        <button class="ghost" id="btnSaveDraft">üíæ √âconomiser (brouillon)</button>
        <button class="danger" id="btnNew">üóëÔ∏è Nouveau bon</button>
      </div>

      <div class="hint" style="margin-top:10px">
        Important : chaque export PDF cr√©e un <b>nouveau num√©ro de bon</b> (unique sur cet appareil via localStorage).
      </div>
    </section>

    <!-- HISTORIQUE -->
    <section class="card hidden" id="tab-hist">
      <div class="btns" style="margin-bottom:10px">
        <button class="ghost" id="btnRefreshHist">üîÑ Actualiser</button>
        <button class="danger" id="btnClearHist">üóëÔ∏è Vider l‚Äôhistorique</button>
      </div>
      <div id="histWrap" class="hint"></div>
    </section>

    <!-- REFERENCES -->
    <section class="card hidden" id="tab-refs">
      <div class="row">
        <div>
          <label>Ajouter une r√©f√©rence</label>
          <input id="newRef" placeholder="Ex: IR CO8 54" />
        </div>
        <div class="right" style="align-items:end">
          <button class="success" id="btnAddRef">‚ûï Ajouter</button>
        </div>
      </div>
      <div class="hint" style="margin-top:6px">Les r√©f√©rences sont enregistr√©es localement (sur cet appareil).</div>

      <!-- IA : acc√®s rapide (si le module IA est pr√©sent) -->
      <div class="btns" id="iaRefsBtns" style="margin-top:10px; display:none">
        <button class="ghost" id="btnIAOpenScan">ü§ñ IA photo (d√©tection)</button>
        <button class="ghost" id="btnIAOpenBase">üìö Base IA (photos par ref)</button>
      </div>
      <div style="margin-top:12px">
        <table>
          <thead><tr><th>R√©f√©rence</th><th></th></tr></thead>
          <tbody id="refsTable"></tbody>
        </table>
      </div>
    </section>

    <!-- MAGASINS -->
    <section class="card hidden" id="tab-codes">
      <div class="row">
        <div>
          <label>Ajouter un magasin (code + libell√©)</label>
          <input id="newMagCode" placeholder="Ex: ISTGS55" />
        </div>
        <div>
          <label>Libell√©</label>
          <input id="newMagLabel" placeholder="Ex: Jean Robert" />
        </div>
      </div>
      <div class="btns" style="margin-top:10px">
        <button class="success" id="btnAddMag">‚ûï Ajouter</button>
      </div>
      <div class="hint" style="margin-top:6px">Les magasins sont enregistr√©s localement (sur cet appareil).</div>

      <div style="margin-top:12px">
        <table>
          <thead><tr><th>Code</th><th>Libell√©</th><th></th></tr></thead>
          <tbody id="magTable"></tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<!-- jsPDF (UMD) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>

<script>
/* --------------------- Storage keys --------------------- */
const K = {
  refs: "inv_refs_v1",
  mags: "inv_mags_v1",
  emit: "inv_emit_v1",
  draft: "inv_draft_v1",
  hist: "inv_hist_v1",
  seq: "inv_bon_seq_v1"
};

const DEFAULT_EMETTEURS = [
  { code: "ISTGS54", label: "ISTGS54" }
];

const DEFAULT_MAGS = [
  { code: "ISTGS54", label: "Magasin principal" },
  { code: "ISTGS55", label: "Jean Robert" }
];

const DEFAULT_REFS = [
  "IR CO8 52","IR CO8 54","IR CO8 71","IR CO8 72",
  "IR CO9 03","IR CO8 03","IR CRP 02","CO CRP 02",
  "SF CO8 11","SJ CO8 12","SJ ?? 12","CZ CO8 12"
].filter(Boolean);

/* --------------------- State --------------------- */
let lines = []; // {ref, qty, neufOui, usiteOui, comment}

/* --------------------- Helpers --------------------- */
const $ = (id) => document.getElementById(id);

function loadJSON(key, fallback){
  try{
    const v = localStorage.getItem(key);
    if(!v) return fallback;
    return JSON.parse(v);
  }catch(e){ return fallback; }
}
function saveJSON(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

function todayISO(){
  const d = new Date();
  const pad = (n) => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function ensureSeq(){
  let seq = Number(localStorage.getItem(K.seq) || "0");
  if(!seq || seq < 1000000){
    // base unique-ish
    seq = Math.floor((Date.now()/1000) % 9000000) + 1000000;
    localStorage.setItem(K.seq, String(seq));
  }
  return seq;
}
function nextBonNumber(){
  const seq = ensureSeq() + 1;
  localStorage.setItem(K.seq, String(seq));
  return String(seq).padStart(7,"0");
}

function sanitizeRef(s){
  return (s || "").trim().replace(/\s+/g," ");
}

/* --------------------- Tabs --------------------- */
document.querySelectorAll(".tab").forEach(t => {
  t.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    t.classList.add("active");
    const name = t.dataset.tab;
    ["bon","hist","refs","codes"].forEach(k => $("tab-"+k).classList.add("hidden"));
    $("tab-"+name).classList.remove("hidden");
    if(name === "hist") renderHist();
    if(name === "refs") renderRefs();
    if(name === "codes") renderMags();
  });
});

/* --------------------- Init selects --------------------- */
function fillSelect(sel, arr){
  sel.innerHTML = "";
  arr.forEach(o => {
    const opt = document.createElement("option");
    opt.value = o.code;
    opt.textContent = o.label ? `${o.code} ‚Äî ${o.label}` : o.code;
    sel.appendChild(opt);
  });
}

function initData(){
  const refs0 = loadJSON(K.refs, null);
  const mags0 = loadJSON(K.mags, null);
  const emit0 = loadJSON(K.emit, null);

  const refs = (Array.isArray(refs0) && refs0.length) ? refs0 : DEFAULT_REFS;
  const mags = (Array.isArray(mags0) && mags0.length) ? mags0 : DEFAULT_MAGS;
  const emit = (Array.isArray(emit0) && emit0.length) ? emit0 : DEFAULT_EMETTEURS;

  saveJSON(K.refs, refs);
  saveJSON(K.mags, mags);
  saveJSON(K.emit, emit);

  fillSelect($("emetteur"), emit);
  fillSelect($("magasin"), mags);

  // Menu d√©roulant des r√©f√©rences
  const refSel = $("refSelect");
  refSel.innerHTML = `<option value="" disabled selected>Choisir une r√©f√©rence...</option>` +
    refs.map(r => `<option value="${r.replaceAll('"','&quot;')}">${escapeHTML(r)}</option>`).join("");

  // L‚Äô√©metteur doit correspondre au magasin
  $("magasin").addEventListener("change", () => { $("emetteur").value = $("magasin").value; });
  // init: aligne au chargement
  $("emetteur").value = $("magasin").value;

  // Interrupteurs NEUF / USIT√â
  function setNeuf(v){
    const yes = (v === "oui");
    $("neufOui").checked = yes; $("neufNon").checked = !yes;
    $("neufSelect").value = v;
    if(yes) setUsite("non");
  }
  function setUsite(v){
    const yes = (v === "oui");
    $("usiteOui").checked = yes; $("usiteNon").checked = !yes;
    $("usiteSelect").value = v;
    if(yes) setNeuf("non");
  }
  // valeurs par d√©faut
  setNeuf("non");
  setUsite("non");
  $("neufOui").addEventListener("change", () => setNeuf($("neufOui").checked ? "oui" : "non"));
  $("neufNon").addEventListener("change", () => setNeuf($("neufNon").checked ? "non" : "oui"));
  $("usiteOui").addEventListener("change", () => setUsite($("usiteOui").checked ? "oui" : "non"));
  $("usiteNon").addEventListener("change", () => setUsite($("usiteNon").checked ? "non" : "oui"));

}

/* --------------------- Lines rendering --------------------- */
function renderLines(){
  const tbody = $("lines");
  tbody.innerHTML = "";
  lines.forEach((l, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHTML(l.ref)}</td>
      <td><span class="pill">x${l.qty}</span></td>
      <td>${l.neufOui ? "<span class='x'>X</span>" : ""}</td>
      <td>${l.usiteOui ? "<span class='x'>X</span>" : ""}</td>
      <td>${escapeHTML(l.comment || "")}</td>
      <td class="right"><button class="danger small" data-del="${idx}">Supprimer</button></td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button[data-del]").forEach(b => {
    b.addEventListener("click", async () => {
      const i = Number(b.dataset.del);
      lines.splice(i,1);
      renderLines();
    });
  });

  const limit = 10;
  $("limitHint").textContent = lines.length > limit
    ? `‚ö†Ô∏è ${lines.length} lignes : le PDF n'affichera que les ${limit} premi√®res (limite du formulaire).`
    : `Limite PDF : ${limit} lignes (comme sur le bon papier).`;
}

function escapeHTML(s){
  return (s || "").replace(/[&<>"]/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}

/* --------------------- Add line --------------------- */
$("btnAdd").addEventListener("click", () => {
  const ref = sanitizeRef($("refSelect").value);
  if(!ref){
    alert("Renseigne une r√©f√©rence.");
    return;
  }
  const qty = Math.max(1, parseInt($("qtyInput").value || "1", 10));
  const neufOui = $("neufSelect").value === "oui";
  const usiteOui = $("usiteSelect").value === "oui";
  const comment = sanitizeRef($("commentInput").value);

  lines.push({ ref, qty, neufOui, usiteOui, comment });
  renderLines();

  // auto-save reference if new
  const refs = loadJSON(K.refs, []);
  if(!refs.includes(ref)){
    refs.unshift(ref);
    saveJSON(K.refs, refs.slice(0,200));
    // Menu d√©roulant des r√©f√©rences
  const refSel = $("refSelect");
  refSel.innerHTML = `<option value="" disabled selected>Choisir une r√©f√©rence...</option>` +
    refs.map(r => `<option value="${r.replaceAll('"','&quot;')}">${escapeHTML(r)}</option>`).join("");

  // L‚Äô√©metteur doit correspondre au magasin
  $("magasin").addEventListener("change", () => { $("emetteur").value = $("magasin").value; });
  // init: aligne au chargement
  $("emetteur").value = $("magasin").value;

  // Interrupteurs NEUF / USIT√â
  function setNeuf(v){
    const yes = (v === "oui");
    $("neufOui").checked = yes; $("neufNon").checked = !yes;
    $("neufSelect").value = v;
    if(yes) setUsite("non");
  }
  function setUsite(v){
    const yes = (v === "oui");
    $("usiteOui").checked = yes; $("usiteNon").checked = !yes;
    $("usiteSelect").value = v;
    if(yes) setNeuf("non");
  }
  // valeurs par d√©faut
  setNeuf("non");
  setUsite("non");
  $("neufOui").addEventListener("change", () => setNeuf($("neufOui").checked ? "oui" : "non"));
  $("neufNon").addEventListener("change", () => setNeuf($("neufNon").checked ? "non" : "oui"));
  $("usiteOui").addEventListener("change", () => setUsite($("usiteOui").checked ? "oui" : "non"));
  $("usiteNon").addEventListener("change", () => setUsite($("usiteNon").checked ? "non" : "oui"));

  }

  $("refSelect").selectedIndex = 0;
  $("qtyInput").value = "1";
  $("commentInput").value = "";
  $("neufSelect").value = "non";
  $("usiteSelect").value = "non";
});

$("btnClearLine").addEventListener("click", () => {
  $("refSelect").selectedIndex = 0;
  $("qtyInput").value = "1";
  $("commentInput").value = "";
  $("neufSelect").value = "non";
  $("usiteSelect").value = "non";
  if ($("neufOui")) { $("neufOui").checked = false; $("neufNon").checked = true; }
  if ($("usiteOui")) { $("usiteOui").checked = false; $("usiteNon").checked = true; }
});

/* --------------------- Draft / new --------------------- */
$("btnSaveDraft").addEventListener("click", () => {
  const draft = collectBon(false);
  saveJSON(K.draft, draft);
  alert("Brouillon enregistr√©.");
});

$("btnNew").addEventListener("click", () => {
  if(confirm("Cr√©er un nouveau bon ? (le brouillon actuel ne sera pas supprim√©)")){
    lines = [];
    $("observations").value = "";
    $("destinataire").value = "STOCK CENTRAL";
    $("date").value = todayISO();
    renderLines();
  }
});

function collectBon(assignNumber){
  return {
    bonNumber: assignNumber ? nextBonNumber() : null,
    emetteur: $("emetteur").value,
    magasin: $("magasin").value,
    destinataire: sanitizeRef($("destinataire").value) || "STOCK CENTRAL",
    date: $("date").value || todayISO(),
    observations: $("observations").value || "",
    lines: lines.slice(0, 10) // PDF limit
  };
}

function pushHistory(entry){
  const hist = loadJSON(K.hist, []);
  hist.unshift(entry);
  saveJSON(K.hist, hist.slice(0, 80));
}

/* --------------------- PDF drawing (jsPDF) --------------------- */
function drawBon(doc, y0, data){
  // A4: 210 x 297 mm. Half: 148.5 mm
  const X = 5;
  const Y = y0 + 5;
  const W = 200;
  const H = 138.5; // leave room inside half A4

  // Outer border
  doc.setDrawColor(0);
  doc.setLineWidth(0.2);
  doc.rect(X, Y, W, H);

  // Header band
  const headerH = 22;
  doc.setFillColor(240,240,240);
  doc.rect(X, Y, W, headerH, "F");
  doc.rect(X, Y, W, headerH);

  // Logo box (approx. "eps")
  doc.setFillColor(180,180,180);
  doc.rect(X+2, Y+3, 26, 14, "F");
  doc.setTextColor(255,255,255);
  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text("eps", X+15, Y+14, {align:"center"});
  doc.setTextColor(0,0,0);

  // Title & subtitle
  doc.setFont("helvetica","bold");
  doc.setFontSize(12);
  doc.text("BON DE SORTIE DE STOCK N¬∞", X+32, Y+9);
  doc.setFont("helvetica","normal");
  doc.setFontSize(7.5);
  doc.text("A JOINDRE IMP√âRATIVEMENT √Ä TOUT RETOUR DU STOCK CENTRAL", X+32, Y+15);

  // Bon number box (red)
  doc.setDrawColor(0);
  doc.rect(X+W-44, Y+4, 42, 14);
  doc.setTextColor(200,0,0);
  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text(data.bonNumber, X+W-23, Y+15, {align:"center"});
  doc.setTextColor(0,0,0);

  // Info fields
  const infoY = Y + headerH + 4;
  doc.setFontSize(8.5);
  doc.setFont("helvetica","bold");
  doc.text("√âMETTEUR :", X+2, infoY);
  doc.setFont("helvetica","normal");
  doc.text(data.emetteur, X+22, infoY);
  doc.setFontSize(7);
  doc.text("(Code technicien)", X+22, infoY+4);

  doc.setFontSize(8.5);
  doc.setFont("helvetica","bold");
  doc.text("MAGASIN :", X+2, infoY+10);
  doc.setFont("helvetica","normal");
  doc.text(data.magasin, X+22, infoY+10);
  doc.setFontSize(7);
  doc.text("(Code magasin)", X+22, infoY+14);

  doc.setFontSize(8.5);
  doc.setFont("helvetica","bold");
  doc.text("DESTINATAIRE :", X+110, infoY);
  doc.setFont("helvetica","normal");
  doc.text(data.destinataire, X+138, infoY);

  doc.setFont("helvetica","bold");
  doc.text("DATE :", X+110, infoY+10);
  doc.setFont("helvetica","normal");
  doc.text(data.date.split("-").reverse().join("/"), X+122, infoY+10);

  // Table
  const tableY = infoY + 18;
  const rowH = 8;
  const header1H = 8;
  const header2H = 7;

  const cRef = 92;
  const cYN = 9; // each Oui/Non column
  const cComm = W - (cRef + 4*cYN);

  // header rectangles
  doc.setFont("helvetica","bold");
  doc.setFontSize(8.5);
  // first header row (merged cells)
  doc.rect(X, tableY, cRef, header1H);
  doc.rect(X+cRef, tableY, 2*cYN, header1H);
  doc.rect(X+cRef+2*cYN, tableY, 2*cYN, header1H);
  doc.rect(X+cRef+4*cYN, tableY, cComm, header1H);

  doc.text("R√âF√âRENCE ARTICLE", X + cRef/2, tableY+5.5, {align:"center"});
  doc.text("NEUF", X + cRef + cYN, tableY+5.5, {align:"center"});
  doc.text("USIT√â", X + cRef + 3*cYN, tableY+5.5, {align:"center"});
  doc.text("COMMENTAIRES", X + cRef + 4*cYN + cComm/2, tableY+5.5, {align:"center"});

  // second header row (Oui/Non)
  const y2 = tableY + header1H;
  // ref col blank
  doc.rect(X, y2, cRef, header2H);
  // NEUF Oui / Non
  doc.rect(X+cRef, y2, cYN, header2H);
  doc.rect(X+cRef+cYN, y2, cYN, header2H);
  // USIT√â Oui / Non
  doc.rect(X+cRef+2*cYN, y2, cYN, header2H);
  doc.rect(X+cRef+3*cYN, y2, cYN, header2H);
  // comm
  doc.rect(X+cRef+4*cYN, y2, cComm, header2H);

  doc.setFontSize(7.5);
  doc.text("Oui", X+cRef + cYN/2, y2+5, {align:"center"});
  doc.text("Non", X+cRef + cYN + cYN/2, y2+5, {align:"center"});
  doc.text("Oui", X+cRef + 2*cYN + cYN/2, y2+5, {align:"center"});
  doc.text("Non", X+cRef + 3*cYN + cYN/2, y2+5, {align:"center"});

  // rows
  const startRowsY = y2 + header2H;
  doc.setFont("helvetica","normal");
  doc.setFontSize(8.5);
  const maxRows = 10;
  for(let i=0;i<maxRows;i++){
    const ry = startRowsY + i*rowH;
    doc.rect(X, ry, cRef, rowH);
    doc.rect(X+cRef, ry, cYN, rowH);
    doc.rect(X+cRef+cYN, ry, cYN, rowH);
    doc.rect(X+cRef+2*cYN, ry, cYN, rowH);
    doc.rect(X+cRef+3*cYN, ry, cYN, rowH);
    doc.rect(X+cRef+4*cYN, ry, cComm, rowH);

    const l = data.lines[i];
    if(l){
      doc.text(l.ref, X+2, ry+5.5);
      const mark = "X";
      // Neuf
      if(l.neufOui) doc.text(mark, X+cRef + cYN/2, ry+5.5, {align:"center"});
      else doc.text(mark, X+cRef + cYN + cYN/2, ry+5.5, {align:"center"});
      // Usit√©
      if(l.usiteOui) doc.text(mark, X+cRef + 2*cYN + cYN/2, ry+5.5, {align:"center"});
      else doc.text(mark, X+cRef + 3*cYN + cYN/2, ry+5.5, {align:"center"});

      const comm = `x${l.qty}` + (l.comment ? ` ${l.comment}` : "");
      doc.text(comm, X+cRef+4*cYN + 2, ry+5.5);
    }
  }

  // Observations
  const obsY = startRowsY + maxRows*rowH + 6;
  doc.setFont("helvetica","bold");
  doc.setFontSize(8.5);
  doc.text("Observations :", X+2, obsY);

  const obsBoxY = obsY + 2;
  const obsBoxH = Y + H - obsBoxY - 4;
  doc.setFont("helvetica","normal");
  doc.setFontSize(8.5);
  doc.rect(X, obsBoxY, W, obsBoxH);
  const obsText = (data.observations || "").trim();
  if(obsText){
    const wrapped = doc.splitTextToSize(obsText, W-4);
    doc.text(wrapped.slice(0,5), X+2, obsBoxY+6); // limit lines to keep clean
  }
}

async function buildPDF(twoCopies=true){
  if(!window.jspdf || !window.jspdf.jsPDF){
    alert("Librairie PDF non charg√©e (jsPDF). V√©rifie ta connexion et recharge la page.");
    return null;
  }
  const data = collectBon(true);
  if(data.lines.length === 0){
    alert("Ajoute au moins une r√©f√©rence avant d'exporter.");
    return null;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"portrait", unit:"mm", format:"a4"});

  // Draw 2 copies on the same A4
  drawBon(doc, 0, data);
  drawBon(doc, 148.5, data);

  // History
  pushHistory({
    ...data,
    createdAt: new Date().toISOString()
  });

  return { doc, bonNumber: data.bonNumber };
}

$("btnPdf").addEventListener("click", async () => {
  const res = await buildPDF(true);
  if(!res) return;
  res.doc.save(`bon_sortie_${res.bonNumber}.pdf`);
});

$("btnShare").addEventListener("click", async () => {
  const res = await buildPDF(true);
  if(!res) return;

  const blob = res.doc.output("blob");
  const file = new File([blob], `bon_sortie_${res.bonNumber}.pdf`, { type: "application/pdf" });

  if(navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
    try{
      await navigator.share({ title: "Bon de sortie / retour", files: [file] });
    }catch(e){
      // user cancelled
    }
  }else{
    // fallback: download
    res.doc.save(`bon_sortie_${res.bonNumber}.pdf`);
    alert("Partage non support√© ici : le PDF a √©t√© t√©l√©charg√© (ouvre-le puis partage depuis ton t√©l√©phone).");
  }
});

/* --------------------- Historique --------------------- */
function renderHist(){
  const hist = loadJSON(K.hist, []);
  if(hist.length === 0){
    $("histWrap").innerHTML = "Aucun bon export√© pour le moment.";
    return;
  }
  const rows = hist.map(h => {
    const dt = (h.date || "").split("-").reverse().join("/");
    return `<div style="padding:10px 0;border-bottom:1px solid var(--border)">
      <div><b>N¬∞ ${h.bonNumber}</b> ‚Äî ${escapeHTML(h.magasin)} ‚Üí ${escapeHTML(h.destinataire)} ‚Äî ${dt}</div>
      <div class="hint">${h.lines.length} ligne(s) ‚Äî ${escapeHTML((h.createdAt||"").replace("T"," ").slice(0,19))}</div>
    </div>`;
  }).join("");
  $("histWrap").innerHTML = rows;
}

$("btnRefreshHist").addEventListener("click", renderHist);
$("btnClearHist").addEventListener("click", () => {
  if(confirm("Supprimer l'historique local ?")){
    localStorage.removeItem(K.hist);
    renderHist();
  }
});

/* --------------------- R√©f√©rences --------------------- */
async function renderRefs(){
  const refs = loadJSON(K.refs, []);
  const tbody = $("refsTable");
  tbody.innerHTML = "";

  // IA present? Show quick access buttons in this tab
  const iaOk = !!(window.AIRefAddon && typeof window.AIRefAddon.openScan === "function");
  const iaBtns = $("iaRefsBtns");
  if (iaBtns) iaBtns.style.display = iaOk ? "flex" : "none";
  if (iaOk) {
    $("btnIAOpenScan").onclick = () => { if(!ensureAI()) return; window.AIRefAddon.openScan(); };
    $("btnIAOpenBase").onclick = () => { if(!ensureAI()) return; window.AIRefAddon.openBase(); };
  }

  // Pull thumbs/counts from 
/* --------------------- IA integration --------------------- */
/* L'addon IA d√©clenche un event "ai-ref-confirmed" et peut appeler window.addReferenceFromAI(ref, meta).
   On utilise √ßa pour:
   - m√©moriser les derniers choix (r√©f + √©tat neuf/usit√©)
   - pr√©-remplir la ligne, et (optionnel) auto-valider la ligne.
*/
(function(){
  const AI_PREF_KEY = "inv_ai_prefs_v1";
  function loadAIPrefs(){
    try{ return JSON.parse(localStorage.getItem(AI_PREF_KEY) || "{}") || {}; }catch(_){ return {}; }
  }
  function saveAIPrefs(p){
    try{ localStorage.setItem(AI_PREF_KEY, JSON.stringify(p||{})); }catch(_){}
  }
  function canonRef(ref){ return String(ref||"").toUpperCase().replace(/[^A-Z0-9]/g,""); }
  function setNeufUsite(neufOui, usiteOui){
    // mutual exclusivity
    if(neufOui) usiteOui = false;
    if(usiteOui) neufOui = false;

    const neufV = neufOui ? "oui" : "non";
    const usiteV = usiteOui ? "oui" : "non";

    const ns = document.getElementById("neufSelect");
    const us = document.getElementById("usiteSelect");
    if(ns) ns.value = neufV;
    if(us) us.value = usiteV;

    const nOui = document.getElementById("neufOui");
    const nNon = document.getElementById("neufNon");
    const uOui = document.getElementById("usiteOui");
    const uNon = document.getElementById("usiteNon");
    if(nOui && nNon){ nOui.checked = neufOui; nNon.checked = !neufOui; }
    if(uOui && uNon){ uOui.checked = usiteOui; uNon.checked = !usiteOui; }
  }

  window.addReferenceFromAI = function(ref, meta){
    try{
      const r = sanitizeRef(ref);
      if(!r) return;

      // prefs
      const prefs = loadAIPrefs();
      prefs.lastRef = r;

      const neufOui = !!(meta && meta.neufOui);
      const usiteOui = !!(meta && meta.usiteOui);
      prefs.lastNeuf = neufOui ? "oui" : "non";
      prefs.lastUsite = usiteOui ? "oui" : "non";
      prefs.perRef = prefs.perRef || {};
      prefs.perRef[canonRef(r)] = { neuf: prefs.lastNeuf, usite: prefs.lastUsite };
      saveAIPrefs(prefs);

      // ensure ref exists in select list
      const sel = document.getElementById("refSelect");
      if(sel){
        const hasOpt = Array.from(sel.options).some(o => sanitizeRef(o.value) === r);
        if(!hasOpt){
          // persist in refs store too (same behaviour as manual add)
          const refsArr = loadJSON(K.refs, []);
          if(!refsArr.includes(r)){
            refsArr.unshift(r);
            saveJSON(K.refs, refsArr.slice(0,200));
          }
          fillSelect(sel, refsArr.map(code=>({code, label:""})));
        }
        sel.value = r;
      }

      const qtyInput = document.getElementById("qtyInput");
      if(qtyInput) qtyInput.value = String(meta && meta.qty ? meta.qty : 1);

      setNeufUsite(neufOui, usiteOui);

      // auto validate line if requested (default true for IA)
      const autoAdd = meta && ("autoAdd" in meta) ? !!meta.autoAdd : true;
      if(autoAdd){
        const btn = document.getElementById("btnAdd");
        if(btn) btn.click();
      }
    }catch(e){
      console.error("addReferenceFromAI error", e);
    }
  };
})();


IA photo base (if available)
  let summary = {};
  if (window.AIRefAddon && typeof window.AIRefAddon.getRefSummary === "function") {
    try { summary = await window.AIRefAddon.getRefSummary(); } catch { summary = {}; }
  }

  refs.forEach((r, idx) => {
    const sum = summary[r] || { count: 0, thumb: null };
    const thumb = sum.thumb
      ? `<img class="ref-thumb" src="${sum.thumb}" alt="photo IA" />`
      : `<span class="hint" style="white-space:nowrap">Aucune photo IA</span>`;
    const countHint = `<div class="hint" style="margin-top:2px">${sum.count || 0} photo(s) IA</div>`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div class="row" style="align-items:center; gap:10px">
          <div style="flex:1; min-width:0">
            <div><b>${escapeHTML(r)}</b></div>
            ${countHint}
          </div>
          <div class="right aiThumbs" data-idx="${idx}" style="min-width:70px">${thumb}</div>
        </div>
      </td>
      <td class="right">
        <button class="ghost small" data-iaref="${idx}">üì∑ IA</button>
        <button class="danger small" data-rdel="${idx}">Supprimer</button>
      </td>`;
    tbody.appendChild(tr);
  });

  // Delete ref
  tbody.querySelectorAll("button[data-rdel]").forEach(b => {
    b.addEventListener("click", async () => {
      const refs2 = loadJSON(K.refs, []);
      const i = Number(b.dataset.rdel);
      const ref = refs2[i];
      if(!ref) return;

      if(!confirm(`Supprimer la r√©f√©rence "${ref}" ?`)) return;

      refs2.splice(i, 1);
      saveJSON(K.refs, refs2);
      renderRefs();

      // Menu d√©roulant des r√©f√©rences (apr√®s ajout/suppression)
      const refSel2 = $("refSelect");
      const opts = `<option value="" disabled selected>Choisir une r√©f√©rence...</option>` +
        refs2.map(r => `<option value="${r.replaceAll('"','&quot;')}">${escapeHTML(r)}</option>`).join("");
      refSel2.innerHTML = opts;
    });
  });

  // Open IA base on a specific reference
  tbody.querySelectorAll("button[data-iaref]").forEach(b => {
    b.addEventListener("click", async () => {
      if (!ensureAI() || typeof window.AIRefAddon.addPhotoForRef !== "function") { return; }
      const ref = refs[Number(b.dataset.iaref)];
      await window.AIRefAddon.addPhotoForRef(ref);
      await renderRefs();
});
  });
  // Click on thumbnails/count to manage photos for this reference
  tbody.querySelectorAll(".aiThumbs").forEach(d => {
    d.addEventListener("click", () => {
      const ref = refs[Number(d.dataset.idx)];
      openBase(ref);
    });
  });

}
$("btnAddRef").addEventListener("click", () => {
  const r = sanitizeRef($("newRef").value);
  if(!r) return;
  const refs = loadJSON(K.refs, []);
  if(!refs.includes(r)) refs.unshift(r);
  saveJSON(K.refs, refs.slice(0,200));
  $("newRef").value = "";
  renderRefs();
  // Menu d√©roulant des r√©f√©rences
  const refSel = $("refSelect");
  refSel.innerHTML = `<option value="" disabled selected>Choisir une r√©f√©rence...</option>` +
    refs.map(r => `<option value="${r.replaceAll('"','&quot;')}">${escapeHTML(r)}</option>`).join("");

  // L‚Äô√©metteur doit correspondre au magasin
  $("magasin").addEventListener("change", () => { $("emetteur").value = $("magasin").value; });
  // init: aligne au chargement
  $("emetteur").value = $("magasin").value;

  // Interrupteurs NEUF / USIT√â
  function setNeuf(v){
    const yes = (v === "oui");
    $("neufOui").checked = yes; $("neufNon").checked = !yes;
    $("neufSelect").value = v;
    if(yes) setUsite("non");
  }
  function setUsite(v){
    const yes = (v === "oui");
    $("usiteOui").checked = yes; $("usiteNon").checked = !yes;
    $("usiteSelect").value = v;
    if(yes) setNeuf("non");
  }
  // valeurs par d√©faut
  setNeuf("non");
  setUsite("non");
  $("neufOui").addEventListener("change", () => setNeuf($("neufOui").checked ? "oui" : "non"));
  $("neufNon").addEventListener("change", () => setNeuf($("neufNon").checked ? "non" : "oui"));
  $("usiteOui").addEventListener("change", () => setUsite($("usiteOui").checked ? "oui" : "non"));
  $("usiteNon").addEventListener("change", () => setUsite($("usiteNon").checked ? "non" : "oui"));

});

/* --------------------- Magasins --------------------- */
function renderMags(){
  const mags = loadJSON(K.mags, []);
  const tbody = $("magTable");
  tbody.innerHTML = "";
  mags.forEach((m, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHTML(m.code)}</td>
      <td>${escapeHTML(m.label || "")}</td>
      <td class="right"><button class="danger small" data-mdel="${idx}">Supprimer</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("button[data-mdel]").forEach(b => {
    b.addEventListener("click", async () => {
      const mags2 = loadJSON(K.mags, []);
      mags2.splice(Number(b.dataset.mdel),1);
      saveJSON(K.mags, mags2);
      fillSelect($("magasin"), mags2);
      renderMags();
    });
  });
}
$("btnAddMag").addEventListener("click", () => {
  const code = sanitizeRef($("newMagCode").value).toUpperCase();
  const label = sanitizeRef($("newMagLabel").value);
  if(!code) return;
  const mags = loadJSON(K.mags, []);
  if(mags.some(m => m.code === code)){
    alert("Ce code magasin existe d√©j√†.");
    return;
  }
  mags.unshift({ code, label });
  saveJSON(K.mags, mags);
  fillSelect($("magasin"), mags);
  $("newMagCode").value = "";
  $("newMagLabel").value = "";
  renderMags();
});

/* --------------------- Service Worker --------------------- */
if("serviceWorker" in navigator){
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js").catch(()=>{});
  });
}

/* --------------------- Boot --------------------- */
initData();
$("date").value = todayISO();

// restore draft if exists
const draft = loadJSON(K.draft, null);
if(draft){
  try{
    $("emetteur").value = draft.emetteur || $("emetteur").value;
    $("magasin").value = draft.magasin || $("magasin").value;
    $("destinataire").value = draft.destinataire || "STOCK CENTRAL";
    $("date").value = draft.date || todayISO();
    $("observations").value = draft.observations || "";
    lines = Array.isArray(draft.lines) ? draft.lines : [];
    renderLines();
  }catch(e){}
}else{
  renderLines();
}
</script>

<!-- IA Photo (optionnel) : module autonome, n'impacte pas le fonctionnement manuel -->
<script>
  window.AI_REF_ADDON_CONFIG = {
    // Si vide, le module IA r√©cup√®re la liste dans l'onglet R√©f√©rences
    refs: [],
    // Seuils de confiance : au-dessus -> auto ; sinon -> demande validation
    threshold_auto: 0.78,
    threshold_min: 0.55,
    // Nombre max d'objets √† traiter (photo de lot)
    max_objects: 20,
    // Stockage
    db_name: "inventaire_ai_ref_db",
    // Debug (console)
    debug: false
  };
</script>
<!-- AI addon (inlined to avoid GitHub Pages 404/cache issues) -->
<script>
/*!
 * PWA AI Add-on (human-in-the-loop + multi-obj)
 * - Keeps your manual app intact; adds floating buttons + modals.
 * - Single photo (1 objet) OR Lot photo (multi objets) -> propose refs -> you validate when unsure -> counts + learns.
 * - Uses TFJS + MobileNet embeddings (CDN) + nearest-neighbor matching (cosine).
 * - Stores learning samples locally in IndexedDB (separate from your existing app data).
 *
 * Integration (zero-impact):
 *   Define window.addReferenceFromAI = (ref, meta) => { call your existing add/increment logic }
 * Or listen:
 *   window.addEventListener("ai-ref-confirmed", (e) => ...)
 */
(function () {
  "use strict";

  const CONFIG = {
    tfjsSrc: "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js",
    mobilenetSrc: "https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.1/dist/mobilenet.min.js",
    ui: { fabRight: 16, fabBottom: 16 },
    db: { name: "ai_ref_db_v2", store: "samples" },
    match: {
      topK: 3,
      autoAcceptThreshold: 0.92,
      margin: 0.06,
      doubtThreshold: 0.80, // below => always ask
    },
    embedding: { endpoint: "conv_preds", size: 224 },
    multi: {
      maxSide: 1280,
      // background segmentation parameters
      bgDelta: 18,
      minAreaRatio: 0.010, // min blob area = 1% of image
      maxAreaRatio: 0.65,
      padRatio: 0.08,
      morphRadius: 2,
    }
  };

  const $ = (sel, root = document) => root.querySelector(sel);

  // Persist AI choices (last ref + last √©tat + √©tat par ref)
  const AI_PREF_KEY = "inv_ai_prefs_v1";
  function loadAIPrefs(){
    try{ return JSON.parse(localStorage.getItem(AI_PREF_KEY) || "{}") || {}; }catch(_){ return {}; }
  }
  function saveAIPrefs(p){
    try{ localStorage.setItem(AI_PREF_KEY, JSON.stringify(p||{})); }catch(_){}
  }
  function canonRef(ref){ return String(ref||"").toUpperCase().replace(/[^A-Z0-9]/g,""); }
  function getCondForRef(ref){
    const p = loadAIPrefs();
    const per = (p.perRef && p.perRef[canonRef(ref)]) ? p.perRef[canonRef(ref)] : null;
    const lastNeuf = p.lastNeuf || "non";
    const lastUsite = p.lastUsite || "non";
    const neuf = per?.neuf || lastNeuf;
    const usite = per?.usite || lastUsite;
    return { neuf, usite };
  }
  function normalizeCond(neuf, usite){
    // enforce exclusivity
    if(neuf==="oui") usite="non";
    if(usite==="oui") neuf="non";
    return { neuf, usite };
  }
  function condUIHTML(ref){
    const c0 = getCondForRef(ref);
    const c = normalizeCond(c0.neuf, c0.usite);
    return `
      <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:#fff">
        <div class="ai-muted" style="margin-bottom:8px"><b>√âtat</b> (m√©moris√©)</div>
        <div class="ai-row">
          <label class="ai-muted" style="min-width:62px">Neuf</label>
          <select class="ai-input" id="ai-cond-neuf" style="max-width:140px">
            <option value="non" ${c.neuf==="non"?"selected":""}>Non</option>
            <option value="oui" ${c.neuf==="oui"?"selected":""}>Oui</option>
          </select>
          <label class="ai-muted" style="min-width:62px">Usit√©</label>
          <select class="ai-input" id="ai-cond-usite" style="max-width:140px">
            <option value="non" ${c.usite==="non"?"selected":""}>Non</option>
            <option value="oui" ${c.usite==="oui"?"selected":""}>Oui</option>
          </select>
        </div>
        <div class="ai-muted" style="margin-top:6px">Astuce : si ‚ÄúNeuf = Oui‚Äù, ‚ÄúUsit√©‚Äù passe automatiquement √† Non (et inversement).</div>
      </div>
    `;
  }
  let _condTouched = false;

  function wireCondUI(){
    _condTouched = false;

    const n = $("#ai-cond-neuf");
    const u = $("#ai-cond-usite");
    if(!n || !u) return;

    function set(group, val){
      _condTouched = true;
      if(group==="neuf"){
        n.value = val;
        if(val==="oui") u.value = "non";
      } else {
        u.value = val;
        if(val==="oui") n.value = "non";
      }

      document.querySelectorAll("button[data-cond]").forEach(b=>{
        const g=b.getAttribute("data-cond");
        const v=b.getAttribute("data-val");
        const cur = (g==="neuf") ? n.value : u.value;
        b.classList.toggle("ghost", v!==cur);
      });
    }

    document.querySelectorAll("button[data-cond]").forEach(b=>{
      b.addEventListener("click", ()=> set(b.getAttribute("data-cond"), b.getAttribute("data-val")));
    });

    // first paint
    document.querySelectorAll("button[data-cond]").forEach(b=>{
      const g=b.getAttribute("data-cond");
      const v=b.getAttribute("data-val");
      const cur = (g==="neuf") ? n.value : u.value;
      b.classList.toggle("ghost", v!==cur);
    });
  }
  function readCondUI(){
    const n = $("#ai-cond-neuf")?.value || "non";
    const u = $("#ai-cond-usite")?.value || "non";
    return normalizeCond(n,u);
  }
  function rememberChoice(ref, cond){
    const p = loadAIPrefs();
    p.lastRef = ref;
    p.lastNeuf = cond.neuf;
    p.lastUsite = cond.usite;
    p.perRef = p.perRef || {};
    p.perRef[canonRef(ref)] = { neuf: cond.neuf, usite: cond.usite };
    saveAIPrefs(p);
  }

  function cosineSimilarity(a, b) {
    let dot = 0, na = 0, nb = 0;
    const n = Math.min(a.length, b.length);
    for (let i = 0; i < n; i++) {
      const x = a[i], y = b[i];
      dot += x * y; na += x * x; nb += y * y;
    }
    if (na === 0 || nb === 0) return 0;
    return dot / (Math.sqrt(na) * Math.sqrt(nb));
  }
  function toFloat32Array(arr) { return (arr instanceof Float32Array) ? arr : new Float32Array(arr); }
  function fmtScore(s) { return (Math.round(s * 1000) / 10).toFixed(1) + "%"; }
  function safeText(s) { return String(s ?? "").replace(/[<>]/g, ""); }

  // ----- IndexedDB -----
  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(CONFIG.db.name, 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(CONFIG.db.store)) {
          const store = db.createObjectStore(CONFIG.db.store, { keyPath: "id", autoIncrement: true });
          store.createIndex("ref", "ref", { unique: false });
          store.createIndex("createdAt", "createdAt", { unique: false });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function dbPut(sample) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(CONFIG.db.store, "readwrite");
      tx.objectStore(CONFIG.db.store).add(sample).onsuccess = (e) => resolve(e.target.result);
      tx.onerror = () => reject(tx.error);
      tx.oncomplete = () => db.close();
    });
  }
  async function dbGetAll() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(CONFIG.db.store, "readonly");
      const req = tx.objectStore(CONFIG.db.store).getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
      tx.oncomplete = () => db.close();
    });
  }
  async function dbDelete(id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(CONFIG.db.store, "readwrite");
      tx.objectStore(CONFIG.db.store).delete(id).onsuccess = () => resolve(true);
      tx.onerror = () => reject(tx.error);
      tx.oncomplete = () => db.close();
    });
  }

  // ----- TFJS/MobileNet -----
  let _tfLoaded = false, _mnLoaded = false, _mn = null;

  function loadScript(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[data-ai-src="${src}"]`)) return resolve();
      const s = document.createElement("script");
      s.src = src; s.async = true; s.defer = true; s.dataset.aiSrc = src;
      s.onload = () => resolve();
      s.onerror = () => reject(new Error("Failed to load " + src));
      document.head.appendChild(s);
    });
  }

  async function ensureModel() {
    if (!_tfLoaded) { await loadScript(CONFIG.tfjsSrc); _tfLoaded = true; }
    if (!_mnLoaded) { await loadScript(CONFIG.mobilenetSrc); _mnLoaded = true; }
    if (!_mn) { _mn = await window.mobilenet.load({ version: 2, alpha: 1.0 }); }
    return _mn;
  }

  function makeCanvas(w, h) {
    const c = document.createElement("canvas");
    c.width = w; c.height = h;
    return c;
  }

  async function imageToEmbedding(imgEl) {
    const mn = await ensureModel();
    const tf = window.tf;

    const canvas = makeCanvas(CONFIG.embedding.size, CONFIG.embedding.size);
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    const w = imgEl.naturalWidth || imgEl.width;
    const h = imgEl.naturalHeight || imgEl.height;
    const side = Math.min(w, h);
    const sx = Math.floor((w - side) / 2);
    const sy = Math.floor((h - side) / 2);

    ctx.drawImage(imgEl, sx, sy, side, side, 0, 0, canvas.width, canvas.height);

    const input = tf.tidy(() => tf.browser.fromPixels(canvas).toFloat().div(255).expandDims(0));
    let emb;
    try {
      const act = mn.infer(input, CONFIG.embedding.endpoint);
      const arr = await act.data();
      emb = toFloat32Array(arr);
      act.dispose?.();
    } finally {
      input.dispose?.();
    }
    return emb;
  }

  async function blobToImage(blob) {
    return new Promise((resolve, reject) => {
      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
      img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
      img.src = url;
    });
  }

  async function fileToThumbDataURL(file, maxSide = 320) {
    const img = await blobToImage(file);
    const w = img.naturalWidth, h = img.naturalHeight;
    const scale = Math.min(1, maxSide / Math.max(w, h));
    const cw = Math.round(w * scale), ch = Math.round(h * scale);
    const c = makeCanvas(cw, ch);
    const ctx = c.getContext("2d");
    ctx.drawImage(img, 0, 0, cw, ch);
    return c.toDataURL("image/jpeg", 0.82);
  }

  async function matchEmbedding(queryEmb) {
    const all = await dbGetAll();
    if (!all.length) return { all, top: [] };

    const scored = all.map(s => ({ sample: s, score: cosineSimilarity(queryEmb, toFloat32Array(s.embedding)) }));
    const bestByRef = new Map();
    for (const x of scored) {
      const ref = x.sample.ref;
      const prev = bestByRef.get(ref);
      if (!prev || x.score > prev.score) bestByRef.set(ref, x);
    }
    const unique = Array.from(bestByRef.values()).sort((a, b) => b.score - a.score);
    return { all, top: unique.slice(0, CONFIG.match.topK) };
  }

  // ----- UI -----
  function injectStyles() {
    if ($("#ai-addon-style")) return;
    const s = document.createElement("style");
    s.id = "ai-addon-style";
    s.textContent = `
      .ai-fab-wrap{position:fixed;right:${CONFIG.ui.fabRight}px;bottom:${CONFIG.ui.fabBottom}px;z-index:99999;display:flex;flex-direction:column;gap:10px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
      .ai-fab{border:none;border-radius:999px;padding:12px 14px;box-shadow:0 8px 20px rgba(0,0,0,.22);background:#111827;color:#fff;font-weight:800;font-size:14px;display:flex;align-items:center;gap:8px;cursor:pointer}
      .ai-fab.secondary{background:#374151}
      /* Modal: sur mobile, le contenu √©tait coup√© en bas (impossible de scroller).
         On rend le modal scrollable + la carte flexible en hauteur. */
      .ai-modal{position:fixed;inset:0;z-index:999999;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,.5);padding:16px;overflow:auto;-webkit-overflow-scrolling:touch;padding-bottom:calc(16px + env(safe-area-inset-bottom));}
      .ai-card{width:min(920px,100%);background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;max-height:calc(100dvh - 32px - env(safe-area-inset-bottom));display:flex;flex-direction:column;}
      .ai-card header{padding:14px 16px;background:#f3f4f6;display:flex;align-items:center;justify-content:space-between;flex:0 0 auto}
      .ai-card header h3{margin:0;font-size:16px}
      .ai-card header button{border:none;background:transparent;font-size:22px;cursor:pointer;line-height:1}
      .ai-card .body{padding:16px;display:grid;grid-template-columns:1fr;gap:14px;overflow:auto;-webkit-overflow-scrolling:touch;flex:1 1 auto}
      @media(min-width:920px){.ai-card .body{grid-template-columns:320px 1fr}}
      .ai-thumb{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;background:#e5e7eb}
      .ai-actions{display:flex;flex-direction:column;gap:10px}
      .ai-btn{border:1px solid #e5e7eb;background:#111827;color:#fff;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;text-align:left}
      .ai-btn.ghost{background:#fff;color:#111827}
      .ai-btn.small{padding:8px 10px;border-radius:10px;font-weight:800}
      .ai-row{display:flex;gap:10px;flex-wrap:wrap}
      .ai-input{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:12px;font-size:14px}
      .ai-muted{color:#6b7280;font-size:13px}
      .ai-list{max-height:min(420px, 45dvh);overflow:auto;border:1px solid #e5e7eb;border-radius:12px;-webkit-overflow-scrolling:touch}
      .ai-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #e5e7eb;gap:10px}
      .ai-item:last-child{border-bottom:none}
      .ai-badge{font-size:12px;background:#eef2ff;color:#3730a3;border-radius:999px;padding:2px 8px;font-weight:800}
      .ai-danger{background:#fee2e2;color:#991b1b}
      .ai-ok{background:#dcfce7;color:#166534}
      .ai-spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(0,0,0,.2);border-top-color:rgba(0,0,0,.6);border-radius:50%;animation:ai-spin 0.8s linear infinite}
      @keyframes ai-spin{to{transform:rotate(360deg)}}
      .ai-kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#f3f4f6;border-radius:8px;padding:2px 6px;font-size:12px}
      .ai-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
      @media(min-width:720px){.ai-grid{grid-template-columns:repeat(3,minmax(0,1fr));}}
      .ai-tile{border:1px solid #e5e7eb;border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:8px}
      .ai-tile.off{opacity:.45;filter:grayscale(.35)}
      .ai-keep{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#374151;user-select:none}
      .ai-keep input{width:16px;height:16px}

      .ai-tile img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px;background:#e5e7eb}
      .ai-select{width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:10px}
      .ai-pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:800;border-radius:999px;padding:3px 10px;background:#f3f4f6}
    `;
    document.head.appendChild(s);
  }

  function injectUI() {
    injectStyles();
    if ($("#ai-fab-wrap")) return;

    const wrap = document.createElement("div");
    wrap.id = "ai-fab-wrap";
    wrap.className = "ai-fab-wrap";

    const btnAI = document.createElement("button");
    btnAI.className = "ai-fab";
    btnAI.type = "button";
    btnAI.textContent = "ü§ñ IA photo";
    btnAI.addEventListener("click", () => openScanModal());

    const btnBase = document.createElement("button");
    btnBase.className = "ai-fab secondary";
    btnBase.type = "button";
    btnBase.textContent = "üìö Base IA";
    btnBase.addEventListener("click", () => openBaseModal());

    wrap.appendChild(btnAI);
    wrap.appendChild(btnBase);
    document.body.appendChild(wrap);

    const modal = document.createElement("div");
    modal.id = "ai-modal";
    modal.className = "ai-modal";
    modal.innerHTML = `
      <div class="ai-card" role="dialog" aria-modal="true" aria-label="IA">
        <header>
          <h3 id="ai-modal-title">IA</h3>
          <button type="button" id="ai-close" aria-label="Fermer">√ó</button>
        </header>
        <div class="body" id="ai-modal-body"></div>
      </div>
    `;
    document.body.appendChild(modal);
    $("#ai-close").addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

    // inputs
    const inputSingle = document.createElement("input");
    inputSingle.id = "ai-file-single";
    inputSingle.type = "file";
    inputSingle.accept = "image/*";
    inputSingle.capture = "environment";
    inputSingle.style.display = "none";
    inputSingle.addEventListener("change", async () => {
      const file = inputSingle.files?.[0];
      inputSingle.value = "";
      if (!file) return;
      await handleSingle(file);
    });
    document.body.appendChild(inputSingle);

    const inputLot = document.createElement("input");
    inputLot.id = "ai-file-lot";
    inputLot.type = "file";
    inputLot.accept = "image/*";
    inputLot.capture = "environment";
    inputLot.style.display = "none";
    inputLot.addEventListener("change", async () => {
      const file = inputLot.files?.[0];
      inputLot.value = "";
      if (!file) return;
      await handleLot(file);
    });
    document.body.appendChild(inputLot);
  }

  function openModal(title, bodyHTML) {
    $("#ai-modal-title").textContent = title;
    $("#ai-modal-body").innerHTML = bodyHTML;
    $("#ai-modal").style.display = "flex";
  }
  function closeModal() { $("#ai-modal").style.display = "none"; }

  function toast(msg) {
    const t = document.createElement("div");
    t.textContent = msg;
    Object.assign(t.style, {
      position: "fixed", left: "50%", bottom: "90px", transform: "translateX(-50%)",
      background: "rgba(17,24,39,.92)", color: "#fff", padding: "10px 12px",
      borderRadius: "999px", boxShadow: "0 8px 22px rgba(0,0,0,.28)", zIndex: "999999",
      fontFamily: "system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif"
    });
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2200);
  }

  // ----- Scan modal -----
  function openScanModal() {
    openModal("IA photo", `
      <div>
        <img id="ai-preview" class="ai-thumb" alt="Aper√ßu"/>
        <div class="ai-muted" style="margin-top:10px">
          <b>1 objet</b> : rapide. <b>Lot</b> : d√©tecte plusieurs objets puis compte par r√©f√©rence. <br>
          Si doute, l‚ÄôIA te demandera de choisir.
        </div>
        <div class="ai-row" style="margin-top:10px">
          <button class="ai-btn" id="ai-take-single">üì∑ 1 objet</button>
          <button class="ai-btn ghost" id="ai-take-lot">üì∏ Lot (multi)</button>
        </div>
        <div class="ai-muted" style="margin-top:8px" id="ai-status"></div>
      </div>
      <div class="ai-actions" id="ai-right">
        <div class="ai-muted">Aucune photo encore.</div>
      </div>
    `);

    $("#ai-take-single").addEventListener("click", () => $("#ai-file-single").click());
    $("#ai-take-lot").addEventListener("click", () => $("#ai-file-lot").click());
  }

  // ----- Single flow -----
  async function handleSingle(file) {
    $("#ai-status").innerHTML = `<span class="ai-spinner"></span> Analyse‚Ä¶`;
    const preview = $("#ai-preview");
    const url = URL.createObjectURL(file);
    preview.src = url;

    try {
      await ensureModel();
      const img = await blobToImage(file);
      const emb = await imageToEmbedding(img);

      const { top } = await matchEmbedding(emb);
      const right = $("#ai-right");

      if (!top.length) {
        right.innerHTML = `
          <div class="ai-muted">Base IA vide. Ajoute une r√©f√©rence :</div>
              <input class="ai-input" id="ai-new-ref" placeholder="R√©f√©rence (ex: IR-CO8-71)" />
          <button class="ai-btn" id="ai-save-first">‚úÖ Enregistrer + compter</button>
        `;
        wireCondUI();
        $("#ai-save-first").addEventListener("click", async () => {
          const ref = safeText($("#ai-new-ref").value).trim();
          if (!ref) return toast("Entre une r√©f√©rence.");
          await saveSample(ref, file, emb);
          toast("Ajout√© + compt√©.");
          emitConfirmed(ref, { score: 1, method: "first_sample_single", cond: readCondUI() });
        });
      } else {
        const best = top[0];
        const second = top[1];
        const autoOk = best.score >= CONFIG.match.autoAcceptThreshold && (!second || (best.score - second.score) >= CONFIG.match.margin);
        const doubt = best.score < CONFIG.match.doubtThreshold;

        right.innerHTML = `
          <div class="ai-muted">Propositions :</div>
          ${condUIHTML(safeText(top[0]?.sample?.ref || ""))}
          ${top.map((x, idx) => `
            <button class="ai-btn ${idx===0 ? "" : "ghost"}" data-ref="${safeText(x.sample.ref)}" data-score="${x.score}">
              ${safeText(x.sample.ref)} <span class="ai-badge">${fmtScore(x.score)}</span>
            </button>
          `).join("")}
          <button class="ai-btn ghost" id="ai-other">‚ûï Autre / Nouvelle ref</button>
          <div class="ai-muted" style="margin-top:6px">Valider = compter + apprendre.</div>
        `;

        wireCondUI();

        right.querySelectorAll("button[data-ref]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const ref = btn.getAttribute("data-ref");
            const score = parseFloat(btn.getAttribute("data-score"));
            await saveSample(ref, file, emb);
            toast(`Valid√© : ${ref}`);
            const cond = _condTouched ? readCondUI() : normalizeCond(getCondForRef(ref).neuf, getCondForRef(ref).usite);
            emitConfirmed(ref, { score, method: "validated_single", cond });
          });
        });

        $("#ai-other").addEventListener("click", () => {
          right.innerHTML = `
            <div class="ai-muted">Nouvelle r√©f√©rence :</div>
            ${condUIHTML("")}
            <input class="ai-input" id="ai-new-ref2" placeholder="R√©f√©rence (ex: IR-CO8-72)" />
            <button class="ai-btn" id="ai-save-new">‚úÖ Enregistrer + compter</button>
          `;
          wireCondUI();
          $("#ai-save-new").addEventListener("click", async () => {
            const ref = safeText($("#ai-new-ref2").value).trim();
            if (!ref) return toast("Entre une r√©f√©rence.");
            await saveSample(ref, file, emb);
            toast(`Ajout√© : ${ref}`);
            emitConfirmed(ref, { score: 1, method: "new_ref_single", cond: readCondUI() });
          });
        });

        // Auto-accept only if confident AND not doubtful
        if (autoOk && !doubt) {
          await saveSample(best.sample.ref, file, emb);
          toast(`Auto : ${best.sample.ref} (${fmtScore(best.score)})`);
          emitConfirmed(best.sample.ref, { score: best.score, method: "auto_single", cond: getCondForRef(best.sample.ref) });
        } else {
          // Explicitly tell user there is doubt
          if (doubt) $("#ai-status").textContent = "Doute : choisis la bonne r√©f√©rence (ou ajoute une nouvelle).";
          else $("#ai-status").textContent = "Choisis/valide une r√©f√©rence.";
        }
      }
    } catch (e) {
      console.error(e);
      $("#ai-status").textContent = "Erreur IA : " + (e?.message || e);
      toast("Erreur IA.");
    } finally {
      URL.revokeObjectURL(url);
    }
  }

  // ----- Multi-object detection (heuristic) -----
  function resizeToMaxSide(img, maxSide) {
    const w = img.naturalWidth || img.width;
    const h = img.naturalHeight || img.height;
    const scale = Math.min(1, maxSide / Math.max(w, h));
    const cw = Math.round(w * scale), ch = Math.round(h * scale);
    const c = makeCanvas(cw, ch);
    const ctx = c.getContext("2d", { willReadFrequently: true });
    ctx.drawImage(img, 0, 0, cw, ch);
    return { canvas: c, scale, w: cw, h: ch };
  }

  function estimateBackgroundGray(data, w, h) {
    // sample border pixels
    let sum = 0, cnt = 0;
    const step = Math.max(1, Math.floor(Math.min(w,h) / 120));
    function grayAt(i){ return (data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114); }
    for (let x=0; x<w; x+=step) {
      let i1 = (0*w + x)*4;
      let i2 = ((h-1)*w + x)*4;
      sum += grayAt(i1) + grayAt(i2); cnt += 2;
    }
    for (let y=0; y<h; y+=step) {
      let i1 = (y*w + 0)*4;
      let i2 = (y*w + (w-1))*4;
      sum += grayAt(i1) + grayAt(i2); cnt += 2;
    }
    return cnt ? (sum / cnt) : 255;
  }

  function morphDilate(mask, w, h, r) {
    const out = new Uint8Array(mask.length);
    for (let y=0; y<h; y++) {
      for (let x=0; x<w; x++) {
        let on = 0;
        for (let dy=-r; dy<=r && !on; dy++) {
          const yy = y+dy; if (yy<0||yy>=h) continue;
          for (let dx=-r; dx<=r; dx++) {
            const xx = x+dx; if (xx<0||xx>=w) continue;
            if (mask[yy*w+xx]) { on = 1; break; }
          }
        }
        out[y*w+x] = on;
      }
    }
    return out;
  }

  function morphErode(mask, w, h, r) {
    const out = new Uint8Array(mask.length);
    for (let y=0; y<h; y++) {
      for (let x=0; x<w; x++) {
        let on = 1;
        for (let dy=-r; dy<=r && on; dy++) {
          const yy = y+dy; if (yy<0||yy>=h) { on=0; break; }
          for (let dx=-r; dx<=r; dx++) {
            const xx = x+dx; if (xx<0||xx>=w) { on=0; break; }
            if (!mask[yy*w+xx]) { on = 0; break; }
          }
        }
        out[y*w+x] = on;
      }
    }
    return out;
  }

  function connectedComponents(mask, w, h) {
    const visited = new Uint8Array(mask.length);
    const boxes = [];
    const dirs = [[1,0],[-1,0],[0,1],[0,-1]];
    for (let i=0;i<mask.length;i++){
      if (!mask[i] || visited[i]) continue;
      visited[i]=1;
      const q=[i];
      let minx=w, miny=h, maxx=0, maxy=0, area=0;
      while(q.length){
        const p=q.pop();
        const y=Math.floor(p/w), x=p%w;
        area++;
        if (x<minx) minx=x; if (y<miny) miny=y;
        if (x>maxx) maxx=x; if (y>maxy) maxy=y;
        for (const [dx,dy] of dirs){
          const xx=x+dx, yy=y+dy;
          if (xx<0||xx>=w||yy<0||yy>=h) continue;
          const j=yy*w+xx;
          if (mask[j] && !visited[j]){ visited[j]=1; q.push(j); }
        }
      }
      boxes.push({x:minx,y:miny,w:(maxx-minx+1),h:(maxy-miny+1),area});
    }
    return boxes;
  }

  function detectBoxesFromImage(img) {
    const { canvas, w, h } = resizeToMaxSide(img, CONFIG.multi.maxSide);
    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    const imgData = ctx.getImageData(0,0,w,h);
    const data = imgData.data;

    const bg = estimateBackgroundGray(data, w, h);
    const delta = CONFIG.multi.bgDelta;
    const mask = new Uint8Array(w*h);

    for (let y=0; y<h; y++) {
      for (let x=0; x<w; x++) {
        const i = (y*w + x)*4;
        const g = data[i]*0.299 + data[i+1]*0.587 + data[i+2]*0.114;
        mask[y*w+x] = (Math.abs(g - bg) > delta) ? 1 : 0;
      }
    }

    // morphological closing to fill holes: dilate then erode
    const r = CONFIG.multi.morphRadius;
    const dil = morphDilate(mask, w, h, r);
    const clo = morphErode(dil, w, h, r);

    const comps = connectedComponents(clo, w, h);

    const minA = w*h*CONFIG.multi.minAreaRatio;
    const maxA = w*h*CONFIG.multi.maxAreaRatio;

    let boxes = comps
      .filter(b => b.area >= minA && b.area <= maxA)
      .filter(b => b.w > 24 && b.h > 24)
      .map(b => {
        // padding
        const pad = Math.round(Math.max(b.w, b.h) * CONFIG.multi.padRatio);
        const x = Math.max(0, b.x - pad);
        const y = Math.max(0, b.y - pad);
        const x2 = Math.min(w, b.x + b.w + pad);
        const y2 = Math.min(h, b.y + b.h + pad);
        return { x, y, w: x2-x, h: y2-y, area: b.area };
      });

    // merge overlapping boxes
    function iou(a,b){
      const x1=Math.max(a.x,b.x), y1=Math.max(a.y,b.y);
      const x2=Math.min(a.x+a.w,b.x+b.w), y2=Math.min(a.y+a.h,b.y+b.h);
      const iw=Math.max(0,x2-x1), ih=Math.max(0,y2-y1);
      const inter=iw*ih;
      const ua=a.w*a.h + b.w*b.h - inter;
      return ua? inter/ua : 0;
    }
    boxes.sort((a,b)=> (b.w*b.h) - (a.w*a.h));
    const merged=[];
    for (const b of boxes){
      let keep=true;
      for (let k=0;k<merged.length;k++){
        if (iou(b, merged[k]) > 0.35){
          // merge into merged[k]
          const m=merged[k];
          const nx=Math.min(m.x,b.x), ny=Math.min(m.y,b.y);
          const nx2=Math.max(m.x+m.w,b.x+b.w), ny2=Math.max(m.y+m.h,b.y+b.h);
          merged[k]={x:nx,y:ny,w:nx2-nx,h:ny2-ny};
          keep=false;
          break;
        }
      }
      if (keep) merged.push({x:b.x,y:b.y,w:b.w,h:b.h});
    }

    // Sort left-to-right, top-to-bottom
    merged.sort((a,b)=> (a.y - b.y) || (a.x - b.x));
    return { boxes: merged, canvas, w, h };
  }

  function cropToDataURL(srcCanvas, box) {
    const c = makeCanvas(box.w, box.h);
    const ctx = c.getContext("2d");
    ctx.drawImage(srcCanvas, box.x, box.y, box.w, box.h, 0, 0, box.w, box.h);
    return c.toDataURL("image/jpeg", 0.9);
  }

  async function dataURLToImage(dataUrl) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = dataUrl;
    });
  }

  // ----- Lot flow -----
  async function handleLot(file) {
    $("#ai-status").innerHTML = `<span class="ai-spinner"></span> D√©tection multi-objets‚Ä¶`;
    const preview = $("#ai-preview");
    const url = URL.createObjectURL(file);
    preview.src = url;

    try {
      await ensureModel();
      const img = await blobToImage(file);
      const det = detectBoxesFromImage(img);

      if (!det.boxes.length) {
        $("#ai-status").textContent = "Aucun objet d√©tect√©. Prends la photo sur un fond uni, objets espac√©s.";
        $("#ai-right").innerHTML = `<div class="ai-muted">Essaie : fond clair + objets s√©par√©s + bonne lumi√®re.</div>`;
        return;
      }

      $("#ai-status").textContent = `Objets d√©tect√©s : ${det.boxes.length}. Analyse des r√©f√©rences‚Ä¶`;

      // For each box: compute emb + topK
      const items = [];
      for (let i=0;i<det.boxes.length;i++){
        const b = det.boxes[i];
        const cropUrl = cropToDataURL(det.canvas, b);
        const cropImg = await dataURLToImage(cropUrl);
        const emb = await imageToEmbedding(cropImg);
        const { top } = await matchEmbedding(emb);
        items.push({ idx:i+1, box:b, cropUrl, emb, top, chosen: null, confidence: top[0]?.score ?? 0 });
      }

      renderLotUI(items, file);

    } catch (e) {
      console.error(e);
      $("#ai-status").textContent = "Erreur IA : " + (e?.message || e);
      toast("Erreur IA.");
    } finally {
      URL.revokeObjectURL(url);
    }
  }

  function renderLotUI(items, file) {
    const right = $("#ai-right");
    // default: keep all detections
    items.forEach(it => { if (typeof it.keep === "undefined") it.keep = true; });
    if (!right) return;

    // If base empty, must ask for each to be labeled (no top)
    const needsLabels = items.some(it => !it.top?.length);

    const tiles = items.map(it => {
      const best = it.top?.[0];
      const second = it.top?.[1];
      const autoOk = best && best.score >= CONFIG.match.autoAcceptThreshold && (!second || (best.score-second.score) >= CONFIG.match.margin) && best.score >= CONFIG.match.doubtThreshold;
      const doubt = !best || best.score < CONFIG.match.doubtThreshold;
      const initial = autoOk ? best.sample.ref : (it.top?.[0]?.sample.ref ?? "");
      const options = (it.top?.length ? it.top : []).map(x => {
        const ref = safeText(x.sample.ref);
        const sel = (ref === initial) ? " selected" : "";
        return `<option value="${ref}"${sel}>${ref} (${fmtScore(x.score)})</option>`;
      }).join("");
// we will "ask" when doubt; auto only when very confident.
      const badge = autoOk ? `<span class="ai-pill"><span class="ai-badge ai-ok">AUTO</span>${fmtScore(best.score)}</span>` :
                    doubt ? `<span class="ai-pill"><span class="ai-badge ai-danger">DOUTE</span>${best ? fmtScore(best.score) : "‚Äî"}</span>` :
                            `<span class="ai-pill"><span class="ai-badge">OK</span>${fmtScore(best.score)}</span>`;

      return `
        <div class="ai-tile ${it.keep===false?"off":""}" data-idx="${it.idx}">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div style="display:flex;align-items:center;gap:10px">
              <b>Objet ${it.idx}</b>
              <label class="ai-keep"><input type="checkbox" data-keep="${it.idx}" ${it.keep===false?"":"checked"}> garder</label>
            </div>
            ${badge}
          </div>
          <img src="${it.cropUrl}" alt="crop ${it.idx}"/>
          <div class="ai-muted">Choisis la r√©f√©rence si doute :</div>
          <select class="ai-select" data-pick="${it.idx}">
            <option value="">‚Äî choisir ‚Äî</option>
            ${options}
          </select>
          <input class="ai-input" data-new="${it.idx}" placeholder="Ou saisir une nouvelle ref (optionnel)"/>
          
          <div class="ai-row" style="gap:8px;margin-top:8px;flex-wrap:wrap">
            <div style="flex:1;min-width:140px">
              <div class="ai-muted">Neuf</div>
              <select class="ai-select" data-cond-neuf="${it.idx}">
                <option value="non" ${normalizeCond(getCondForRef(initial).neuf, getCondForRef(initial).usite).neuf==="non"?"selected":""}>Non</option>
                <option value="oui" ${normalizeCond(getCondForRef(initial).neuf, getCondForRef(initial).usite).neuf==="oui"?"selected":""}>Oui</option>
              </select>
            </div>
            <div style="flex:1;min-width:140px">
              <div class="ai-muted">Usit√©</div>
              <select class="ai-select" data-cond-usite="${it.idx}">
                <option value="non" ${normalizeCond(getCondForRef(initial).neuf, getCondForRef(initial).usite).usite==="non"?"selected":""}>Non</option>
                <option value="oui" ${normalizeCond(getCondForRef(initial).neuf, getCondForRef(initial).usite).usite==="oui"?"selected":""}>Oui</option>
              </select>
            </div>
          </div>

          <button class="ai-btn small ghost" data-apply="${it.idx}">Appliquer</button>
        </div>
      `;
    }).join("");

    right.innerHTML = `
      <div class="ai-muted">Validation lot : si une case est en <span class="ai-kbd">DOUTE</span>, clique ‚ÄúAppliquer‚Äù apr√®s avoir choisi/saisi la bonne ref.</div>
      ${condUIHTML("")}

      <div class="ai-row" style="margin-top:10px">
        <button class="ai-btn small ghost" id="ai-keep-all">Tout garder</button>
        <button class="ai-btn small ghost" id="ai-keep-auto">Garder AUTO</button>
        <button class="ai-btn small ghost" id="ai-keep-none">Tout √©carter</button>
      </div>
      <div class="ai-muted" id="ai-keep-stats" style="margin-top:6px"></div>
      <div class="ai-grid" style="margin-top:10px">${tiles}</div>
      <div class="ai-row" style="margin-top:12px">
        <button class="ai-btn" id="ai-lot-confirm">‚úÖ Valider & compter tout le lot</button>
        <button class="ai-btn ghost" id="ai-lot-cancel">‚Ü©Ô∏é Reprendre photo</button>
      </div>
      <div class="ai-muted" id="ai-lot-hint" style="margin-top:8px"></div>
    `;

    // Etat par objet (Neuf/Usit√©) : exclusif
    right.querySelectorAll("select[data-cond-neuf]").forEach(sel=>{
      sel.addEventListener("change", ()=>{
        const idx = sel.getAttribute("data-cond-neuf");
        const u = right.querySelector(`select[data-cond-usite="${idx}"]`);
        if(sel.value==="oui" && u) u.value="non";
      });
    });
    right.querySelectorAll("select[data-cond-usite]").forEach(sel=>{
      sel.addEventListener("change", ()=>{
        const idx = sel.getAttribute("data-cond-usite");
        const n = right.querySelector(`select[data-cond-neuf="${idx}"]`);
        if(sel.value==="oui" && n) n.value="non";
      });
    });

    wireCondUI();

    // Keep / discard toggles
    const updateKeepStats = () => {
      const kept = items.filter(x => x.keep !== false).length;
      const total = items.length;
      const el = $("#ai-keep-stats");
      if (el) el.textContent = `${kept}/${total} objet(s) gard√©(s). D√©coche ‚Äúgarder‚Äù pour ignorer une d√©tection.`;
    };
    updateKeepStats();

    right.querySelectorAll('input[type="checkbox"][data-keep]').forEach(chk => {
      chk.addEventListener("change", () => {
        const idx = parseInt(chk.getAttribute("data-keep"), 10);
        const it = items.find(x => x.idx === idx);
        if (it) it.keep = chk.checked;
        const tile = right.querySelector(`.ai-tile[data-idx="${idx}"]`);
        if (tile) tile.classList.toggle("off", !chk.checked);
        updateKeepStats();
      });
    });

    const setAllKeep = (mode) => {
      for (const it of items){
        if (it.keep === false) continue;
        const best = it.top?.[0];
        const second = it.top?.[1];
        const autoOk = best && best.score >= CONFIG.match.autoAccept && (!second || (best.score - second.score) >= CONFIG.match.margin) && best.score >= CONFIG.match.doubtThreshold;
        if (mode === "all") it.keep = true;
        if (mode === "none") it.keep = false;
        if (mode === "auto") it.keep = !!autoOk;
      }
      // refresh UI
      right.querySelectorAll('input[type="checkbox"][data-keep]').forEach(chk => {
        const idx = parseInt(chk.getAttribute("data-keep"), 10);
        const it = items.find(x => x.idx === idx);
        chk.checked = (it?.keep !== false);
        const tile = right.querySelector(`.ai-tile[data-idx="${idx}"]`);
        if (tile) tile.classList.toggle("off", !chk.checked);
      });
      updateKeepStats();
    };

    $("#ai-keep-all")?.addEventListener("click", () => setAllKeep("all"));
    $("#ai-keep-none")?.addEventListener("click", () => setAllKeep("none"));
    $("#ai-keep-auto")?.addEventListener("click", () => setAllKeep("auto"));

    // Auto-save selection without requiring "Appliquer"
    right.querySelectorAll('select[data-pick]').forEach(sel => {
      sel.addEventListener("change", () => {
        const idx = parseInt(sel.getAttribute("data-pick"), 10);
        const it = items.find(x => x.idx === idx);
        if (it) it.chosen = safeText(sel.value).trim();
      });
    });
    right.querySelectorAll('input[data-new]').forEach(inp => {
      inp.addEventListener("input", () => {
        const idx = parseInt(inp.getAttribute("data-new"), 10);
        const it = items.find(x => x.idx === idx);
        if (it) it.chosen = safeText(inp.value).trim();
      });
    });



    // Per-tile apply
    right.querySelectorAll("button[data-apply]").forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = parseInt(btn.getAttribute("data-apply"), 10);
        const sel = right.querySelector(`select[data-pick="${idx}"]`);
        const inp = right.querySelector(`input[data-new="${idx}"]`);
        const valNew = safeText(inp?.value).trim();
        const valSel = safeText(sel?.value).trim();
        const ref = valNew || valSel;
        if (!ref) return toast("Choisis ou saisis une r√©f√©rence.");
        const it = items.find(x => x.idx === idx);
        if (it) it.chosen = ref;
        toast(`Objet ${idx} ‚Üí ${ref}`);
      });
    });

    $("#ai-lot-cancel").addEventListener("click", () => openScanModal());

    $("#ai-lot-confirm").addEventListener("click", async () => {
      // For each item: decide ref
      // rule: if very confident autoOk -> take best; else require chosen
      const missing = [];
      const decisions = [];
      const keptCount = items.filter(x => x.keep !== false).length;
      if (!keptCount) {
        $("#ai-lot-hint").textContent = "Aucun objet gard√©. Coche au moins une d√©tection.";
        toast("Rien √† valider.");
        return;
      }
      for (const it of items){
        const best = it.top?.[0];
        const second = it.top?.[1];
        const autoOk = best && best.score >= CONFIG.match.autoAcceptThreshold && (!second || (best.score-second.score) >= CONFIG.match.margin) && best.score >= CONFIG.match.doubtThreshold;
        const ref = autoOk ? best.sample.ref : it.chosen;
        if (!ref) missing.push(it.idx);
        else decisions.push({ it, ref, score: autoOk ? best.score : (best?.score ?? 0), auto: autoOk });
      }

      if (missing.length) {
        $("#ai-lot-hint").textContent = "Doute sur objet(s) : " + missing.join(", ") + ". Choisis une r√©f√©rence puis ‚ÄúAppliquer‚Äù.";
        toast("Il manque des validations.");
        return;
      }

      // save samples + emit counts
      $("#ai-lot-hint").innerHTML = `<span class="ai-spinner"></span> Enregistrement + comptage‚Ä¶`;
      try {
        for (const d of decisions){
          // save sample from crop as thumbnail + embedding
          const blob = await (await fetch(d.it.cropUrl)).blob();
          const file2 = new File([blob], `crop_${d.it.idx}.jpg`, { type: blob.type || "image/jpeg" });
          await saveSample(d.ref, file2, d.it.emb);
          emitConfirmed(d.ref, { score: d.score, method: d.auto ? "auto_lot" : "validated_lot", idx: d.it.idx, cond: normalizeCond((right.querySelector(`select[data-cond-neuf="${d.it.idx}"]`)?.value) || getCondForRef(d.ref).neuf, (right.querySelector(`select[data-cond-usite="${d.it.idx}"]`)?.value) || getCondForRef(d.ref).usite) });
        }
        toast("Lot compt√©.");
        $("#ai-lot-hint").textContent = "Termin√©.";
      } catch (e) {
        console.error(e);
        $("#ai-lot-hint").textContent = "Erreur : " + (e?.message || e);
        toast("Erreur.");
      }
    });
  }

  // ----- Save sample + emit -----
  async function saveSample(ref, file, embedding) {
    const thumb = await fileToThumbDataURL(file);
    const sample = { ref, embedding: Array.from(embedding), thumb, createdAt: Date.now() };
    await dbPut(sample);
  }

  function emitConfirmed(ref, meta) {
    const r = safeText(ref).trim();
    const m = meta || {};
    // condition: from meta.cond or UI or stored per-ref
    let cond = m.cond;
    if (!cond) {
      // if UI present, read it; otherwise use stored value for this ref
      try{
        const nSel = right.querySelector(`select[data-cond-neuf="${it.idx}"]`);
        const uSel = right.querySelector(`select[data-cond-usite="${it.idx}"]`);
        cond = normalizeCond(nSel?.value || getCondForRef(r).neuf, uSel?.value || getCondForRef(r).usite);
      }catch(_){
        const c = getCondForRef(r);
        cond = normalizeCond(c.neuf, c.usite);
      }
    } else {
      cond = normalizeCond(cond.neuf || "non", cond.usite || "non");
    }
    // remember choice
    try{ rememberChoice(r, cond); }catch(_){}

    const payload = {
      ref: r,
      ...m,
      cond,
      neufOui: cond.neuf === "oui",
      usiteOui: cond.usite === "oui",
      autoAdd: ("autoAdd" in m) ? !!m.autoAdd : true,
    };

    window.dispatchEvent(new CustomEvent("ai-ref-confirmed", { detail: payload }));
    try { if (typeof window.addReferenceFromAI === "function") window.addReferenceFromAI(r, payload); } catch {}
  }

  // ----- Base manager -----
  async function openBaseModal(preselectRef = null) {
    const all = await dbGetAll();
    const byRef = new Map();
    for (const s of all) { const arr = byRef.get(s.ref) || []; arr.push(s); byRef.set(s.ref, arr); }
    const refs = Array.from(byRef.keys()).sort((a,b)=>a.localeCompare(b,"fr"));

    openModal("Base IA", `
      <div>
        <div class="ai-muted">Ajouter un exemple (photo + ref) :</div>
        <input class="ai-input" id="ai-ref-add" placeholder="R√©f√©rence (ex: IR-CO8-71)" />
        <div class="ai-row" style="margin-top:10px">
          <button class="ai-btn" id="ai-add-photo">üì∑ Ajouter une photo</button>
          <button class="ai-btn ghost" id="ai-export-json">‚¨áÔ∏è Export JSON</button>
        </div>
        <div class="ai-muted" style="margin-top:8px" id="ai-base-status"></div>
        <div class="ai-muted" style="margin-top:14px">R√©f√©rences enregistr√©es :</div>
        <div class="ai-list" id="ai-ref-list">
          ${refs.length ? refs.map(r => `
            <div class="ai-item">
              <div><div><b>${safeText(r)}</b></div><div class="ai-muted">${byRef.get(r).length} exemple(s)</div></div>
              <div class="ai-row"><button class="ai-btn small ghost" data-open="${safeText(r)}">Voir</button></div>
            </div>
          `).join("") : `<div class="ai-item"><span class="ai-muted">Aucune r√©f√©rence.</span></div>`}
        </div>
      </div>
      <div class="ai-actions" id="ai-ref-detail">
        <div class="ai-muted">S√©lectionne une r√©f√©rence pour voir/supprimer ses exemples.</div>
      </div>
    `);

    // Pr√©-remplir avec le dernier choix m√©moris√© (si dispo)
    try{
      const p = loadAIPrefs();
      if (!preselectRef && p && p.lastRef) $("#ai-ref-add").value = safeText(p.lastRef);
    }catch(_){}

    // Pre-fill and optionally open a specific reference (requested by the host app)
    if (preselectRef) {
      const pref = safeText(preselectRef).trim();
      $("#ai-ref-add").value = pref;
      if (byRef.has(pref)) renderRefDetail(pref, byRef.get(pref) || []);
    }

    $("#ai-add-photo").addEventListener("click", () => {
      const ref = safeText($("#ai-ref-add").value).trim();
      if (!ref) return toast("Entre une r√©f√©rence.");
      const fileInput = document.createElement("input");
      fileInput.type = "file"; fileInput.accept = "image/*"; fileInput.capture = "environment";
      fileInput.addEventListener("change", async () => {
        const f = fileInput.files?.[0];
        if (!f) return;
        $("#ai-base-status").innerHTML = `<span class="ai-spinner"></span> Ajout‚Ä¶`;
        try {
          await ensureModel();
          const img = await blobToImage(f);
          const emb = await imageToEmbedding(img);
          await saveSample(ref, f, emb);
          $("#ai-base-status").textContent = "Exemple ajout√©.";
          toast("Ajout√©.");
          await openBaseModal(ref);
        } catch (e) {
          console.error(e);
          $("#ai-base-status").textContent = "Erreur : " + (e?.message || e);
          toast("Erreur IA.");
        }
      });
      fileInput.click();
    });

    $("#ai-export-json").addEventListener("click", async () => {
      const all2 = await dbGetAll();
      const exportData = {
        version: 2,
        exportedAt: new Date().toISOString(),
        samples: all2.map(s => ({ id: s.id, ref: s.ref, createdAt: s.createdAt, thumb: s.thumb }))
      };
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "base_ia_export.json";
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    });

    document.querySelectorAll("button[data-open]").forEach(btn => {
      btn.addEventListener("click", () => {
        const ref = btn.getAttribute("data-open");
        renderRefDetail(ref, byRef.get(ref) || []);
      });
    });

    // (no-op)
  }

  // Quick-add: capture/select a photo and attach it as a training sample for a specific reference.
  // Designed to work on mobile/PWA: the <input type="file"> is attached to DOM and triggered from a user gesture.
  let _addRefInput = null;
  function _ensureAddRefInput(){
    if (_addRefInput) return _addRefInput;
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'image/*';
    // Hint mobile browsers to open camera when possible
    inp.setAttribute('capture', 'environment');
    inp.style.position = 'fixed';
    inp.style.left = '-9999px';
    inp.style.top = '-9999px';
    inp.id = 'ai-addref-input';
    document.body.appendChild(inp);
    _addRefInput = inp;
    return _addRefInput;
  }

  async function addPhotoForRef(ref){
    const cleanRef = String(ref || '').trim();
    if (!cleanRef) { toast('R√©f√©rence invalide'); return; }
    const input = _ensureAddRefInput();
    input.value = '';

    return new Promise((resolve) => {
      input.onchange = async () => {
        try{
          const f = input.files && input.files[0];
          if (!f) { resolve(false); return; }
          await ensureModel();
          const img = await blobToImage(f);
          const emb = await imageToEmbedding(img);
          await saveSample(cleanRef, f, emb);
          toast(`Photo IA ajout√©e pour ${cleanRef}`);
          window.dispatchEvent(new CustomEvent('ai-base-updated', { detail: { ref: cleanRef } }));
          resolve(true);
        }catch(e){
          console.error(e);
          toast('Erreur ajout photo IA');
          resolve(false);
        }finally{
          input.value = '';
        }
      };
      // Must be called directly from a click/tap handler
      input.click();
    });
  }

  function renderRefDetail(ref, samples) {
    const detail = $("#ai-ref-detail");
    detail.innerHTML = `
      <div><b>${safeText(ref)}</b> <span class="ai-badge">${samples.length} ex.</span></div>
      <div class="ai-muted">Supprime un exemple si mauvaise validation.</div>
      <div class="ai-list" style="margin-top:8px">
        ${samples.slice().sort((a,b)=>b.createdAt-a.createdAt).map(s => `
          <div class="ai-item">
            <div style="display:flex;align-items:center;gap:10px">
              <img src="${s.thumb}" alt="thumb" style="width:44px;height:44px;border-radius:10px;object-fit:cover;background:#e5e7eb"/>
              <div><div class="ai-muted">${new Date(s.createdAt).toLocaleString("fr-FR")}</div><div class="ai-muted">id: ${s.id}</div></div>
            </div>
            <button class="ai-btn small ai-danger" data-del="${s.id}">Suppr.</button>
          </div>
        `).join("")}
      </div>
    `;
    detail.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = parseInt(btn.getAttribute("data-del"), 10);
        if (!Number.isFinite(id)) return;
        if(!confirm("Supprimer cet exemple IA ?")) return;
        await dbDelete(id);
        toast("Supprim√©.");
        await openBaseModal(ref);
      });
    });
  }

  // Provide minimal read access for the host UI (thumbnails / count per reference)
  async function getRefSummary() {
    const all = await dbGetAll();
    const out = {};
    for (const s of all) {
      const ref = safeText(s.ref);
      if (!out[ref]) out[ref] = { count: 0, thumb: null, _latest: 0 };
      out[ref].count += 1;
      if ((s.createdAt || 0) >= out[ref]._latest) {
        out[ref]._latest = s.createdAt || 0;
        out[ref].thumb = s.thumb || null;
      }
    }
    // remove internal field
    for (const k of Object.keys(out)) delete out[k]._latest;
    return out;
  }

  function init() {
    injectUI();
    window.addEventListener("keydown", (e) => { if (e.altKey && (e.key === "i" || e.key === "I")) openScanModal(); });
  }
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();

  window.AIRefAddon = { openScan: openScanModal, openBase: openBaseModal, addPhotoForRef, getRefSummary };
})();
</script>
</body>
</html>
