<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#1d4ed8" />
  <title>Bon de sortie / retour de stock</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{--bg:#f5f7fb;--card:#fff;--muted:#6b7280;--text:#111827;--blue2:#2563eb;--green:#16a34a;--border:#e5e7eb;--shadow:0 10px 30px rgba(17,24,39,.08);--radius:18px}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(245,247,251,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    h1{margin:0;font-size:26px;line-height:1.15}
    .sub{color:var(--muted);margin-top:6px;font-size:14px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .tab{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;user-select:none}
    .tab.active{background:rgba(37,99,235,.10);border-color:rgba(37,99,235,.25)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:920px){.grid{grid-template-columns:520px 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .hd{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .bd{padding:14px}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(37,99,235,.10);border-color:rgba(37,99,235,.25)}
    .btn.blue{background:var(--blue2);border-color:var(--blue2);color:#fff}
    .btn.green{background:var(--green);border-color:var(--green);color:#fff}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;outline:none}
    textarea{min-height:86px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:5px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
    .badge.blue{border-color:rgba(37,99,235,.25);background:rgba(37,99,235,.08)}
    .badge.gray{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .divider{height:1px;background:var(--border);margin:12px 0}
    .list{display:grid;gap:10px}
    .itemCard{border:1px solid var(--border);border-radius:16px;padding:12px;background:#fff;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:5px 10px;font-size:12px;background:#fff;color:var(--muted)}
    .chip strong{color:var(--text)}
    .sumTitle{font-weight:900}
    .sumSub{font-size:12px;color:var(--muted);margin-top:2px}
    .sumGrid{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .sumBox{border:1px solid var(--border);border-radius:14px;padding:8px 10px;background:#fff;font-size:12px}

    /* toggles */
    .yn{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .ynbox{border:1px solid var(--border);border-radius:16px;padding:12px;background:#fff}
    .ynbox.neuf{background:#e8f1ff}
    .ynbox.usite{background:#fff6dd}
    .ynTitle{font-weight:800;margin-bottom:8px}
    .ynRow{display:flex;align-items:center;justify-content:space-between;padding:6px 0}
    .toggle{width:52px;height:30px;border-radius:999px;background:#e5e7eb;position:relative;cursor:pointer;flex:0 0 auto}
    .toggle::after{content:"";position:absolute;top:4px;left:4px;width:22px;height:22px;border-radius:50%;background:#fff;transition:.15s;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .toggle.on{background:rgba(37,99,235,.35)}
    .toggle.on::after{left:26px}

    /* print */
    .printArea{display:none}
    @media print{
      header, main, .toast {display:none !important}
      body{background:#fff}
      .printArea{display:block}
    }
    .a4{width:210mm;min-height:297mm;margin:0 auto}
    .copy{padding:10mm 10mm 8mm 10mm}
    .cut{border-top:1px dashed #999;margin:6mm 0}
    body.print-1 .cut, body.print-1 #printCopy2Wrap{display:none}
    .bon{border:1px solid #111;padding:8mm;font-family:Arial,sans-serif;color:#000;background:#fff}
    .bonTop{display:grid;grid-template-columns:38mm 1fr 52mm;gap:6mm;align-items:start}
    .logoBox{width:38mm;height:22mm;border:1px solid #111;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;letter-spacing:.5px;background:#f2f2f2}
    .titleBox{font-size:16px;font-weight:800;letter-spacing:.3px}
    .subtitleBox{font-size:10px;margin-top:2mm}
    .numBox{border:1px solid #111;padding:3mm 4mm;font-size:18px;font-weight:800;color:#c00;text-align:center}
    .meta{margin-top:4mm;display:grid;grid-template-columns:1fr 1fr;gap:2mm 10mm;font-size:11px}
    .meta div{display:flex;gap:2mm}
    .meta .lbl{min-width:26mm;font-weight:700}
    .meta .val{border-bottom:1px solid #111;flex:1}
    .tableWrap{margin-top:5mm;border:1px solid #111}
    table.bonTable{width:100%;border-collapse:collapse;font-size:11px}
    table.bonTable th, table.bonTable td{border:1px solid #111;padding:2.2mm 2mm;vertical-align:middle}
    table.bonTable th{background:#d9dde6;font-weight:800;text-transform:uppercase;font-size:10px}
    table.bonTable .center{text-align:center}
    .x{font-weight:900;font-size:14px;line-height:1}
    .obs{margin-top:4mm;font-size:11px}
    .obsLine{border-bottom:1px dotted #111;min-height:6mm;white-space:pre-wrap}
    .foot{margin-top:4mm;font-size:10px;text-align:right}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:300;display:none;background:#111827;color:#fff;border-radius:999px;padding:10px 12px;max-width:calc(100% - 24px)}
    .toast.on{display:block}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div>
        <h1>Gestion d'Inventaire</h1>
        <div class="sub">Bon de sortie / retour de stock ‚Äî sans scanner</div>
      </div>
      <button class="btn" id="btnInstall" style="display:none">‚¨áÔ∏è Installer</button>
      <span class="right badge gray">Sauvegarde locale</span>
    </div>
    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="bon">üìÑ Nouveau Bon</div>
      <div class="tab" data-tab="hist">üïò Historique</div>
      <div class="tab" data-tab="refs">üì¶ R√©f√©rences</div>
      <div class="tab" data-tab="codes">üè¨ Codes</div>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="page-bon" class="grid">
    <div class="card">
      <div class="hd">
        <div class="row" style="gap:8px">
          <span class="badge blue">BON DE SORTIE DE STOCK</span>
          <span class="badge gray">N¬∞ <span class="mono" id="bonNumber">‚Äî</span></span>
          <span class="badge gray" id="bonStatus">Brouillon</span>
        </div>
        <button class="btn" id="btnResetBon">‚Ü©Ô∏è R√©initialiser</button>
      </div>
      <div class="bd">
        <label>Code Magasin/Technicien *</label>
        <select id="bonCode"></select>

        <label>Date</label>
        <input id="bonDate" type="date" />

        <label>Destinataire</label>
        <input id="bonDest" placeholder="STOCK CENTRAL" />

        <div class="divider"></div>

        <div class="row">
          <div style="font-weight:800">Articles (<span id="articleCount">0</span>)</div>
          <button class="btn primary right" id="btnAddArticle">Ôºã Ajouter un article</button>
        </div>
        <div id="articles" class="list" style="margin-top:10px"></div>

        <div class="divider"></div>

        <label>Observations</label>
        <textarea id="bonObs" placeholder="Notes ou observations..."></textarea>

        <div class="divider"></div>

        <div class="row">
          <button class="btn green" id="btnSaveDraft">üíæ √âconomiser (brouillon)</button>
          <button class="btn blue" id="btnPrint1">üñ®Ô∏è Imprimer (x1)</button>
          <button class="btn blue right" id="btnPrint2">üñ®Ô∏è Imprimer (x2 sur 1 A4)</button>
        </div>

        <div class="small muted" style="margin-top:10px;line-height:1.4">
          Sauvegarde locale via <span class="mono">localStorage</span>. MDN :
          https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage<br/>
          <b>Important :</b> chaque impression cr√©e un <b>nouveau num√©ro de bon</b> (unique).
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <div style="font-weight:800">Objectif</div>
          <div class="small muted">Transcrire le bon comme ta feuille</div>
        </div>
        <div class="row right">
          <button class="btn" id="btnExport">‚¨áÔ∏è Export</button>
          <button class="btn" id="btnImport">‚¨ÜÔ∏è Import</button>
          <input id="fileImport" type="file" accept="application/json" hidden />
        </div>
      </div>
      <div class="bd">
        <div class="muted" style="font-size:13px;line-height:1.5">
          ‚Ä¢ Ajout d‚Äôarticle : tu remplis puis <b>Valider</b> ‚Üí √ßa passe en mode compact (visible et modifiable).<br/>
          ‚Ä¢ Impression : 1 exemplaire (x1) ou 2 exemplaires sur une seule feuille A4 (x2).<br/>
          ‚Ä¢ Les r√©f√©rences et magasins restent enregistr√©s pour les prochaines fois.
        </div>
      </div>
    </div>
  </section>

  <section id="page-hist" class="card" style="display:none">
    <div class="hd">
      <div>
        <div style="font-weight:800">Historique des Bons</div>
        <div class="small muted">Ouvre un brouillon pour modifier</div>
      </div>
      <input id="histSearch" placeholder="Rechercher (num√©ro, destinataire, code...)" style="width:280px" />
    </div>
    <div class="bd">
      <div id="histList" class="list"></div>
    </div>
  </section>

  <section id="page-refs" class="card" style="display:none">
    <div class="hd">
      <div style="font-weight:800">R√©f√©rences</div>
      <button class="btn primary right" id="btnAddRef">Ôºã Ajouter</button>
    </div>
    <div class="bd"><div id="refList" class="list"></div></div>
  </section>

  <section id="page-codes" class="card" style="display:none">
    <div class="hd">
      <div style="font-weight:800">Codes Magasin / Technicien</div>
      <button class="btn primary right" id="btnAddCode">Ôºã Ajouter</button>
    </div>
    <div class="bd"><div id="codeList" class="list"></div></div>
  </section>
</main>

<div class="printArea">
  <div class="a4">
    <div class="copy"><div id="printCopy1"></div></div>
    <div class="cut"></div>
    <div class="copy" id="printCopy2Wrap"><div id="printCopy2"></div></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =======================
   Gestion Inventaire PWA
   - R√©f√©rences : menu d√©roulant fiable + persistant
   - Statuts NEUF / USIT√â : style "cartes" + choix exclusif
   - √âmetteur = Magasin (auto-synchronis√©)
   - Export PDF : 2 bons sur 1 A4 (jsPDF)
   ======================= */

const K = {
  refs: "inv_refs_v1",
  mags: "inv_mags_v1",
  draft: "inv_draft_v1",
  hist: "inv_hist_v1",
  seq: "inv_bon_seq_v1"
};

const DEFAULT_MAGS = [
  { code: "ISTGS54", label: "Magasin principal" },
  { code: "ISTGS55", label: "Jean Robert" }
];

const DEFAULT_REFS = [
  "IR CO8 52","IR CO8 54","IR CO8 71","IR CO8 72",
  "IR CO9 03","IR CO8 03","IR CRP 02","CO CRP 02",
  "SF CO8 11","SJ CO8 12","SJ ?? 12","CZ CO8 12"
].filter(Boolean);

let lines = []; // {ref, qty, neufOui, usiteOui, comment}

const $ = (id) => document.getElementById(id);

function loadJSON(key, fallback){
  try{
    const v = localStorage.getItem(key);
    if(!v) return fallback;
    return JSON.parse(v);
  }catch(_){
    return fallback;
  }
}
function saveJSON(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

function pad2(n){ return String(n).padStart(2, "0"); }
function todayISO(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function ddmmyyyy(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
}
function sanitizeRef(s){
  return (s || "").trim().replace(/\s+/g, " ");
}
function escapeHTML(s){
  return (s || "").replace(/[&<>"]/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}

/* ---------- Num√©ro de bon unique ---------- */
function ensureSeq(){
  let seq = Number(localStorage.getItem(K.seq) || "0");
  if(!seq || seq < 1000000){
    seq = Math.floor((Date.now()/1000) % 9000000) + 1000000;
    localStorage.setItem(K.seq, String(seq));
  }
  return seq;
}
function nextBonNumber(){
  const seq = ensureSeq() + 1;
  localStorage.setItem(K.seq, String(seq));
  return String(seq).padStart(7, "0");
}

/* ---------- UI helpers ---------- */
function fillSelect(sel, arr){
  sel.innerHTML = "";
  arr.forEach(o => {
    const opt = document.createElement("option");
    opt.value = o.code;
    opt.textContent = o.label ? `${o.code} ‚Äî ${o.label}` : o.code;
    sel.appendChild(opt);
  });
}

function refreshRefSelect(refs, keepValue){
  const sel = $("refSelect");
  const current = keepValue ? sel.value : "";
  sel.innerHTML =
    `<option value="" disabled ${current ? "" : "selected"}>Choisir une r√©f√©rence...</option>` +
    refs.map(r => `<option value="${r.replaceAll('"','&quot;')}">${escapeHTML(r)}</option>`).join("");
  if(keepValue && current && refs.includes(current)) sel.value = current;
  else sel.value = "";
}

function setNeuf(value){
  const yes = value === "oui";
  $("neufOui").checked = yes;
  $("neufNon").checked = !yes;
  $("neufSelect").value = yes ? "oui" : "non";
  if(yes) setUsite("non");
}
function setUsite(value){
  const yes = value === "oui";
  $("usiteOui").checked = yes;
  $("usiteNon").checked = !yes;
  $("usiteSelect").value = yes ? "oui" : "non";
  if(yes) setNeuf("non");
}
function initStatus(){
  // d√©faut : Non / Non
  setNeuf("non");
  setUsite("non");

  // Interrupteurs : on force toujours un √©tat (Oui ou Non)
  $("neufOui").addEventListener("change", () => setNeuf($("neufOui").checked ? "oui" : "non"));
  $("neufNon").addEventListener("change", () => setNeuf($("neufNon").checked ? "non" : "oui"));

  $("usiteOui").addEventListener("change", () => setUsite($("usiteOui").checked ? "oui" : "non"));
  $("usiteNon").addEventListener("change", () => setUsite($("usiteNon").checked ? "non" : "oui"));
}

function resetLineInputs(){
  $("refSelect").value = "";
  $("qtyInput").value = "1";
  $("commentInput").value = "";
  setNeuf("non");
  setUsite("non");
}

/* ---------- Tabs ---------- */
document.querySelectorAll(".tab").forEach(t => {
  t.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    t.classList.add("active");
    const name = t.dataset.tab;
    ["bon","hist","refs","codes"].forEach(k => $("tab-"+k).classList.add("hidden"));
    $("tab-"+name).classList.remove("hidden");
    if(name === "hist") renderHist();
    if(name === "refs") renderRefs();
    if(name === "codes") renderMags();
  });
});

/* ---------- Init data ---------- */
function initData(){
  const refs = loadJSON(K.refs, null) || DEFAULT_REFS;
  const mags = loadJSON(K.mags, null) || DEFAULT_MAGS;

  saveJSON(K.refs, refs);
  saveJSON(K.mags, mags);

  // Magasin
  fillSelect($("magasin"), mags);

  // √âmetteur = Magasin (m√™me liste, d√©sactiv√©)
  fillSelect($("emetteur"), mags);
  $("emetteur").disabled = true;

  const syncEmitter = () => { $("emetteur").value = $("magasin").value; };
  $("magasin").addEventListener("change", syncEmitter);
  syncEmitter();

  // R√©f√©rences
  refreshRefSelect(refs, false);

  // Date d√©faut
  $("date").value = todayISO();
}

/* ---------- Lines rendering ---------- */
function renderLines(){
  const tbody = $("lines");
  tbody.innerHTML = "";

  lines.forEach((l, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHTML(l.ref)}</td>
      <td><span class="pill">x${l.qty}</span></td>
      <td>${l.neufOui ? "<span class='x'>X</span>" : ""}</td>
      <td>${l.usiteOui ? "<span class='x'>X</span>" : ""}</td>
      <td>${escapeHTML(l.comment || "")}</td>
      <td class="right"><button class="danger small" data-del="${idx}">Supprimer</button></td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button[data-del]").forEach(b => {
    b.addEventListener("click", () => {
      const i = Number(b.dataset.del);
      lines.splice(i, 1);
      renderLines();
    });
  });

  const limit = 10;
  $("limitHint").textContent =
    lines.length > limit
      ? `‚ö†Ô∏è ${lines.length} lignes : le PDF n'affichera que les ${limit} premi√®res (limite du formulaire).`
      : `Limite PDF : ${limit} lignes (comme sur le bon papier).`;
}

/* ---------- Add line ---------- */
$("btnAdd").addEventListener("click", () => {
  const ref = sanitizeRef($("refSelect").value);
  if(!ref){
    alert("Renseigne une r√©f√©rence.");
    return;
  }
  const qty = Math.max(1, parseInt($("qtyInput").value || "1", 10));
  const neufOui = $("neufSelect").value === "oui";
  const usiteOui = $("usiteSelect").value === "oui";
  const comment = sanitizeRef($("commentInput").value);

  lines.push({ ref, qty, neufOui, usiteOui, comment });
  renderLines();

  // Persist the ref if new
  const refs = loadJSON(K.refs, []);
  if(!refs.includes(ref)){
    refs.unshift(ref);
    saveJSON(K.refs, refs.slice(0, 200));
    refreshRefSelect(refs, false);
  }

  resetLineInputs();
});

$("btnClearLine").addEventListener("click", resetLineInputs);

/* ---------- Draft / new ---------- */
function collectBon(assignNumber){
  return {
    bonNumber: assignNumber ? nextBonNumber() : null,
    emetteur: $("emetteur").value,
    magasin: $("magasin").value,
    destinataire: sanitizeRef($("destinataire").value) || "STOCK CENTRAL",
    date: $("date").value || todayISO(),
    observations: $("observations").value || "",
    lines: lines.slice(0, 10)
  };
}

function pushHistory(entry){
  const hist = loadJSON(K.hist, []);
  hist.unshift(entry);
  saveJSON(K.hist, hist.slice(0, 80));
}

$("btnSaveDraft").addEventListener("click", () => {
  saveJSON(K.draft, collectBon(false));
  alert("Brouillon enregistr√©.");
});

$("btnNew").addEventListener("click", () => {
  if(confirm("Cr√©er un nouveau bon ? (le brouillon actuel ne sera pas supprim√©)")){
    lines = [];
    $("observations").value = "";
    $("destinataire").value = "STOCK CENTRAL";
    $("date").value = todayISO();
    renderLines();
    resetLineInputs();
  }
});

/* ---------- PDF drawing (jsPDF) ---------- */
function drawBon(doc, y0, data){
  // A4: 210 x 297 mm. Half: 148.5 mm
  const X = 5;
  const Y = y0 + 5;
  const W = 200;
  const H = 138.5;

  doc.setDrawColor(0);
  doc.setLineWidth(0.2);
  doc.rect(X, Y, W, H);

  // Header band
  const headerH = 22;
  doc.setFillColor(240,240,240);
  doc.rect(X, Y, W, headerH, "F");
  doc.rect(X, Y, W, headerH);

  // Logo box (approx eps)
  doc.setFillColor(180,180,180);
  doc.rect(X+2, Y+3, 26, 14, "F");
  doc.setTextColor(255,255,255);
  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text("eps", X+15, Y+14, {align:"center"});
  doc.setTextColor(0,0,0);

  // Title & subtitle
  doc.setFont("helvetica","bold");
  doc.setFontSize(12);
  doc.text("BON DE SORTIE DE STOCK N¬∞", X+32, Y+9);
  doc.setFont("helvetica","normal");
  doc.setFontSize(7.5);
  doc.text("A JOINDRE IMP√âRATIVEMENT √Ä TOUT RETOUR DU STOCK CENTRAL", X+32, Y+15);

  // Bon number box (red)
  doc.setDrawColor(0);
  doc.rect(X+W-44, Y+4, 42, 14);
  doc.setTextColor(200,0,0);
  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text(data.bonNumber, X+W-23, Y+15, {align:"center"});
  doc.setTextColor(0,0,0);

  // Info fields
  const infoY = Y + headerH + 4;
  doc.setFontSize(8.5);
  doc.setFont("helvetica","bold");
  doc.text("√âMETTEUR :", X+2, infoY);
  doc.setFont("helvetica","normal");
  doc.text(data.emetteur, X+22, infoY);
  doc.setFontSize(7);
  doc.text("(Code technicien)", X+22, infoY+4);

  doc.setFontSize(8.5);
  doc.setFont("helvetica","bold");
  doc.text("MAGASIN :", X+2, infoY+10);
  doc.setFont("helvetica","normal");
  doc.text(data.magasin, X+22, infoY+10);
  doc.setFontSize(7);
  doc.text("(Code magasin)", X+22, infoY+14);

  doc.setFontSize(8.5);
  doc.setFont("helvetica","bold");
  doc.text("DESTINATAIRE :", X+110, infoY);
  doc.setFont("helvetica","normal");
  doc.text(data.destinataire, X+138, infoY);

  doc.setFont("helvetica","bold");
  doc.text("DATE :", X+110, infoY+10);
  doc.setFont("helvetica","normal");
  doc.text(ddmmyyyy(data.date), X+122, infoY+10);

  // Table
  const tableY = infoY + 18;
  const rowH = 8;
  const header1H = 8;
  const header2H = 7;

  const cRef = 92;
  const cYN = 9;
  const cComm = W - (cRef + 4*cYN);

  doc.setFont("helvetica","bold");
  doc.setFontSize(8.5);

  // first header row
  doc.rect(X, tableY, cRef, header1H);
  doc.rect(X+cRef, tableY, 2*cYN, header1H);
  doc.rect(X+cRef+2*cYN, tableY, 2*cYN, header1H);
  doc.rect(X+cRef+4*cYN, tableY, cComm, header1H);

  doc.text("R√âF√âRENCE ARTICLE", X + cRef/2, tableY+5.5, {align:"center"});
  doc.text("NEUF", X + cRef + cYN, tableY+5.5, {align:"center"});
  doc.text("USIT√â", X + cRef + 3*cYN, tableY+5.5, {align:"center"});
  doc.text("COMMENTAIRES", X + cRef + 4*cYN + cComm/2, tableY+5.5, {align:"center"});

  // second header row
  const y2 = tableY + header1H;
  doc.rect(X, y2, cRef, header2H);
  doc.rect(X+cRef, y2, cYN, header2H);
  doc.rect(X+cRef+cYN, y2, cYN, header2H);
  doc.rect(X+cRef+2*cYN, y2, cYN, header2H);
  doc.rect(X+cRef+3*cYN, y2, cYN, header2H);
  doc.rect(X+cRef+4*cYN, y2, cComm, header2H);

  doc.setFontSize(7.5);
  doc.text("Oui", X+cRef + cYN/2, y2+5, {align:"center"});
  doc.text("Non", X+cRef + cYN + cYN/2, y2+5, {align:"center"});
  doc.text("Oui", X+cRef + 2*cYN + cYN/2, y2+5, {align:"center"});
  doc.text("Non", X+cRef + 3*cYN + cYN/2, y2+5, {align:"center"});

  // rows
  const startRowsY = y2 + header2H;
  doc.setFont("helvetica","normal");
  doc.setFontSize(8.5);

  const maxRows = 10;
  for(let i=0;i<maxRows;i++){
    const ry = startRowsY + i*rowH;
    doc.rect(X, ry, cRef, rowH);
    doc.rect(X+cRef, ry, cYN, rowH);
    doc.rect(X+cRef+cYN, ry, cYN, rowH);
    doc.rect(X+cRef+2*cYN, ry, cYN, rowH);
    doc.rect(X+cRef+3*cYN, ry, cYN, rowH);
    doc.rect(X+cRef+4*cYN, ry, cComm, rowH);

    const l = data.lines[i];
    if(l){
      doc.text(l.ref, X+2, ry+5.5);
      const mark = "X";

      // NEUF : si neufOui, X en "Oui" sinon en "Non"
      if(l.neufOui) doc.text(mark, X+cRef + cYN/2, ry+5.5, {align:"center"});
      else doc.text(mark, X+cRef + cYN + cYN/2, ry+5.5, {align:"center"});

      // USIT√â : si usiteOui, X en "Oui" sinon en "Non"
      if(l.usiteOui) doc.text(mark, X+cRef + 2*cYN + cYN/2, ry+5.5, {align:"center"});
      else doc.text(mark, X+cRef + 3*cYN + cYN/2, ry+5.5, {align:"center"});

      const comm = `x${l.qty}` + (l.comment ? ` ${l.comment}` : "");
      doc.text(comm, X+cRef+4*cYN + 2, ry+5.5);
    }
  }

  // Observations
  const obsY = startRowsY + maxRows*rowH + 6;
  doc.setFont("helvetica","bold");
  doc.setFontSize(8.5);
  doc.text("Observations :", X+2, obsY);

  const obsBoxY = obsY + 2;
  const obsBoxH = Y + H - obsBoxY - 4;
  doc.setFont("helvetica","normal");
  doc.setFontSize(8.5);
  doc.rect(X, obsBoxY, W, obsBoxH);

  const obsText = (data.observations || "").trim();
  if(obsText){
    const wrapped = doc.splitTextToSize(obsText, W-4);
    doc.text(wrapped.slice(0,5), X+2, obsBoxY+6);
  }
}

async function buildPDF(){
  if(!window.jspdf || !window.jspdf.jsPDF){
    alert("Librairie PDF non charg√©e (jsPDF). V√©rifie ta connexion et recharge la page.");
    return null;
  }
  if(lines.length === 0){
    alert("Ajoute au moins une r√©f√©rence avant d'exporter.");
    return null;
  }

  const data = collectBon(true);

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"portrait", unit:"mm", format:"a4"});
  drawBon(doc, 0, data);
  drawBon(doc, 148.5, data);

  pushHistory({ ...data, createdAt: new Date().toISOString() });

  return { doc, bonNumber: data.bonNumber };
}

$("btnPdf").addEventListener("click", async () => {
  const res = await buildPDF();
  if(!res) return;
  res.doc.save(`bon_sortie_${res.bonNumber}.pdf`);
});

$("btnShare").addEventListener("click", async () => {
  const res = await buildPDF();
  if(!res) return;

  const blob = res.doc.output("blob");
  const file = new File([blob], `bon_sortie_${res.bonNumber}.pdf`, { type: "application/pdf" });

  if(navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
    try{
      await navigator.share({ title: "Bon de sortie / retour", files: [file] });
    }catch(_){}
  }else{
    res.doc.save(`bon_sortie_${res.bonNumber}.pdf`);
    alert("Partage non support√© ici : le PDF a √©t√© t√©l√©charg√© (ouvre-le puis partage depuis ton t√©l√©phone).");
  }
});

/* ---------- Historique ---------- */
function renderHist(){
  const hist = loadJSON(K.hist, []);
  if(hist.length === 0){
    $("histWrap").innerHTML = "Aucun bon export√© pour le moment.";
    return;
  }
  $("histWrap").innerHTML = hist.map(h => {
    return `<div style="padding:10px 0;border-bottom:1px solid var(--border)">
      <div><b>N¬∞ ${escapeHTML(h.bonNumber || "")}</b> ‚Äî ${escapeHTML(h.magasin || "")} ‚Üí ${escapeHTML(h.destinataire || "")} ‚Äî ${escapeHTML(ddmmyyyy(h.date || ""))}</div>
      <div class="hint">${(h.lines||[]).length} ligne(s) ‚Äî ${escapeHTML((h.createdAt||"").replace("T"," ").slice(0,19))}</div>
    </div>`;
  }).join("");
}

$("btnRefreshHist").addEventListener("click", renderHist);
$("btnClearHist").addEventListener("click", () => {
  if(confirm("Supprimer l'historique local ?")){
    localStorage.removeItem(K.hist);
    renderHist();
  }
});

/* ---------- R√©f√©rences ---------- */
function renderRefs(){
  const refs = loadJSON(K.refs, []);
  const tbody = $("refsTable");
  tbody.innerHTML = "";
  refs.forEach((r, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHTML(r)}</td>
      <td class="right"><button class="danger small" data-rdel="${idx}">Supprimer</button></td>`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button[data-rdel]").forEach(b => {
    b.addEventListener("click", () => {
      const refs2 = loadJSON(K.refs, []);
      refs2.splice(Number(b.dataset.rdel), 1);
      saveJSON(K.refs, refs2);
      renderRefs();
      refreshRefSelect(refs2, false);
    });
  });
}

$("btnAddRef").addEventListener("click", () => {
  const r = sanitizeRef($("newRef").value);
  if(!r) return;
  const refs = loadJSON(K.refs, []);
  if(!refs.includes(r)) refs.unshift(r);
  saveJSON(K.refs, refs.slice(0, 200));
  $("newRef").value = "";
  renderRefs();
  refreshRefSelect(refs, true);
});

/* ---------- Magasins ---------- */
function renderMags(){
  const mags = loadJSON(K.mags, []);
  const tbody = $("magTable");
  tbody.innerHTML = "";
  mags.forEach((m, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHTML(m.code)}</td>
      <td>${escapeHTML(m.label || "")}</td>
      <td class="right"><button class="danger small" data-mdel="${idx}">Supprimer</button></td>`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button[data-mdel]").forEach(b => {
    b.addEventListener("click", () => {
      const mags2 = loadJSON(K.mags, []);
      mags2.splice(Number(b.dataset.mdel), 1);
      saveJSON(K.mags, mags2);
      fillSelect($("magasin"), mags2);
      fillSelect($("emetteur"), mags2);
      // resync
      $("emetteur").value = $("magasin").value;
      renderMags();
    });
  });
}

$("btnAddMag").addEventListener("click", () => {
  const code = sanitizeRef($("newMagCode").value).toUpperCase();
  const label = sanitizeRef($("newMagLabel").value);
  if(!code) return;

  const mags = loadJSON(K.mags, []);
  if(mags.some(m => m.code === code)){
    alert("Ce code magasin existe d√©j√†.");
    return;
  }
  mags.unshift({ code, label });
  saveJSON(K.mags, mags);
  fillSelect($("magasin"), mags);
  fillSelect($("emetteur"), mags);
  $("emetteur").value = $("magasin").value;

  $("newMagCode").value = "";
  $("newMagLabel").value = "";
  renderMags();
});

/* ---------- Service Worker ---------- */
if("serviceWorker" in navigator){
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js").catch(()=>{});
  });
}

/* ---------- Boot ---------- */
initData();
initStatus();
renderLines();

// restore draft if exists
const draft = loadJSON(K.draft, null);
if(draft){
  try{
    $("magasin").value = draft.magasin || $("magasin").value;
    $("emetteur").value = $("magasin").value;
    $("destinataire").value = draft.destinataire || "STOCK CENTRAL";
    $("date").value = draft.date || todayISO();
    $("observations").value = draft.observations || "";
    lines = Array.isArray(draft.lines) ? draft.lines : [];
    renderLines();
  }catch(_){}
}
</script>
</body>
</html>
